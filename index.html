<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neurodivergenz-Toolkit</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a2e;
            color: #eee;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #f39c12;
        }

        .navigation {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            padding: 0 10px 5px;
            position: sticky;
            top: 0;
            z-index: 100;
            background: #1a1a2e;
            padding-top: 10px;
            padding-bottom: 10px;
        }

        @media (max-width: 480px) {
            .navigation {
                display: flex;
                overflow-x: auto;
                gap: 6px;
                padding: 8px 10px;
                margin-bottom: 20px;
                -webkit-overflow-scrolling: touch;
            }
            .navigation::-webkit-scrollbar { display: none; }
            .nav-btn {
                font-size: 11px;
                padding: 8px 10px;
                text-align: center;
                flex-shrink: 0;
            }
        }

        .nav-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 12px;
            background: #2c3e50;
            color: white;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s ease;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .nav-btn.active {
            background: #f39c12;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        .energy-display {
            background: #16213e;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        .spoons-container {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 10px;
            margin: 20px 0;
        }

        .spoon {
            font-size: 40px;
            transition: all 0.3s ease;
        }

        .spoon.full {
            filter: brightness(1);
        }

        .spoon.empty {
            filter: brightness(0.3);
            opacity: 0.5;
        }

        .energy-number {
            font-size: 48px;
            font-weight: bold;
            margin: 20px 0;
        }

        .energy-status {
            font-size: 20px;
            padding: 10px 20px;
            border-radius: 25px;
            display: inline-block;
        }

        .status-good {
            background: #27ae60;
        }

        .status-warning {
            background: #f39c12;
            animation: pulse 2s infinite;
        }

        .status-critical {
            background: #e74c3c;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        .activities-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .activity-btn {
            background: #2c3e50;
            border: none;
            border-radius: 10px;
            padding: 15px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .activity-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .activity-btn.energy-gain {
            background: #27ae60;
        }

        .activity-btn.energy-drain-low {
            background: #34495e;
        }

        .activity-btn.energy-drain-medium {
            background: #7f8c8d;
        }

        .activity-btn.energy-drain-high {
            background: #c0392b;
        }

        .energy-cost {
            font-size: 20px;
            font-weight: bold;
        }

        .undo-container {
            margin-top: 20px;
            height: 40px;
        }

        .undo-btn {
            background: #e67e22;
            border: none;
            border-radius: 10px;
            padding: 10px 20px;
            color: white;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
            display: inline-block;
        }

        .undo-btn:hover {
            transform: scale(1.05);
            background: #d35400;
        }

        .history {
            background: #16213e;
            border-radius: 15px;
            padding: 20px;
            margin-top: 30px;
        }

        .history-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #2c3e50;
        }

        .history-item:last-child {
            border-bottom: none;
        }

        .history-item-content {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
        }

        .history-item-actions {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .delete-btn {
            background: transparent;
            border: none;
            color: #e74c3c;
            cursor: pointer;
            font-size: 18px;
            padding: 5px;
            opacity: 0.7;
            transition: all 0.2s ease;
        }

        .delete-btn:hover {
            opacity: 1;
            transform: scale(1.2);
        }

        .reset-day {
            background: #e74c3c;
            border: none;
            border-radius: 10px;
            padding: 15px 30px;
            color: white;
            cursor: pointer;
            font-size: 16px;
            display: block;
            margin: 20px auto;
            transition: all 0.3s ease;
        }

        .reset-day:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .morning-checkin {
            background: #16213e;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            text-align: center;
        }

        .slider {
            width: 100%;
            margin: 20px 0;
        }

        .slider-value {
            font-size: 24px;
            font-weight: bold;
            color: #f39c12;
        }

        input[type="range"] {
            width: 100%;
            height: 10px;
            border-radius: 5px;
            background: #2c3e50;
            outline: none;
            -webkit-appearance: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background: #f39c12;
            cursor: pointer;
        }

        input[type="range"]::-moz-range-thumb {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            background: #f39c12;
            cursor: pointer;
            border: none;
        }

        .start-day-btn {
            background: #27ae60;
            border: none;
            border-radius: 10px;
            padding: 15px 30px;
            color: white;
            cursor: pointer;
            font-size: 18px;
            margin-top: 20px;
            transition: all 0.3s ease;
        }

        .start-day-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .hidden {
            display: none;
        }

        /* Statistics Styles */
        .stats-container {
            background: #16213e;
            border-radius: 15px;
            padding: 30px;
            margin-bottom: 30px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: #2c3e50;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
        }

        .stat-card h3 {
            color: #f39c12;
            margin-bottom: 10px;
        }

        .stat-value {
            font-size: 36px;
            font-weight: bold;
            margin: 10px 0;
        }

        .export-import {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
        }

        .export-btn, .import-btn {
            background: #27ae60;
            border: none;
            border-radius: 10px;
            padding: 12px 24px;
            color: white;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .export-btn:hover, .import-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }

        .import-input {
            display: none;
        }

        .insights {
            background: #16213e;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
        }

        .insight-item {
            padding: 15px;
            margin: 10px 0;
            background: #2c3e50;
            border-radius: 10px;
            border-left: 4px solid #f39c12;
        }

        .top-activities {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .activity-stat {
            background: #2c3e50;
            border-radius: 10px;
            padding: 20px;
        }

        .activity-stat.drain {
            border-top: 3px solid #e74c3c;
        }

        .activity-stat.gain {
            border-top: 3px solid #27ae60;
        }

        .activity-stat h4 {
            color: #f39c12;
            margin-bottom: 15px;
            text-align: center;
        }

        .activity-stat p {
            margin: 8px 0;
            display: flex;
            justify-content: space-between;
        }
  
  /* Mini-Motivator Styles */
.motivator-container {
    max-width: 900px;
    margin: 0 auto;
    padding: 20px;
}

.motivator-container h2 {
    text-align: center;
    color: #f39c12;
    margin-bottom: 10px;
}

.motivator-subtitle {
    text-align: center;
    color: #bbb;
    font-size: 18px;
    margin-bottom: 30px;
}

.mood-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 15px;
    margin-bottom: 30px;
}

.mood-btn {
    background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
    border: none;
    border-radius: 15px;
    padding: 20px;
    color: white;
    cursor: pointer;
    transition: all 0.3s ease;
    text-align: left;
    display: flex;
    flex-direction: column;
    gap: 8px;
    position: relative;
    overflow: hidden;
}

.mood-btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.3);
    background: linear-gradient(135deg, #3a4f66 0%, #4a5f7a 100%);
}

.mood-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
    transition: left 0.5s ease;
}

.mood-btn:hover::before {
    left: 100%;
}

.mood-icon {
    font-size: 32px;
    margin-bottom: 5px;
}

.mood-name {
    font-size: 18px;
    font-weight: bold;
    color: #f39c12;
}

.mood-desc {
    font-size: 14px;
    color: #bbb;
    line-height: 1.3;
}

.unknown-btn {
    background: linear-gradient(135deg, #8e44ad 0%, #9b59b6 100%) !important;
    border: 2px dashed rgba(255,255,255,0.3);
}

.unknown-btn:hover {
    background: linear-gradient(135deg, #a569bd 0%, #bb8fce 100%) !important;
}

.suggestion-display {
    text-align: center;
    animation: fadeIn 0.5s ease;
}

.suggestion-card {
    background: linear-gradient(135deg, #16213e 0%, #1a2b4a 100%);
    border-radius: 20px;
    padding: 40px;
    margin-bottom: 20px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    border: 1px solid rgba(243, 156, 18, 0.2);
}

.suggestion-card h3 {
    color: #f39c12;
    margin-bottom: 25px;
    font-size: 24px;
}

.suggestion-content {
    font-size: 20px;
    line-height: 1.6;
    margin-bottom: 30px;
    color: #eee;
    padding: 20px;
    background: rgba(255,255,255,0.05);
    border-radius: 10px;
    border-left: 4px solid #f39c12;
}

.suggestion-actions {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 20px;
    flex-wrap: wrap;
}

.try-again-btn {
    background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
    border: none;
    border-radius: 25px;
    padding: 12px 25px;
    color: white;
    cursor: pointer;
    font-size: 16px;
    transition: all 0.3s ease;
}

.try-again-btn:hover {
    transform: scale(1.05);
    box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
}

.feedback-buttons {
    display: flex;
    gap: 15px;
}

.feedback-btn {
    background: #2c3e50;
    border: 2px solid transparent;
    border-radius: 50%;
    width: 50px;
    height: 50px;
    cursor: pointer;
    font-size: 20px;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
}

.feedback-btn.good:hover {
    background: #27ae60;
    border-color: #2ecc71;
    transform: scale(1.1);
}

.feedback-btn.bad:hover {
    background: #e74c3c;
    border-color: #c0392b;
    transform: scale(1.1);
}

.feedback-btn.selected {
    transform: scale(1.1);
}

.feedback-btn.good.selected {
    background: #27ae60;
    border-color: #2ecc71;
}

.feedback-btn.bad.selected {
    background: #e74c3c;
    border-color: #c0392b;
}

.back-to-moods-btn {
    background: transparent;
    border: 2px solid #7f8c8d;
    border-radius: 25px;
    padding: 12px 25px;
    color: #7f8c8d;
    cursor: pointer;
    font-size: 16px;
    transition: all 0.3s ease;
}

.back-to-moods-btn:hover {
    border-color: #f39c12;
    color: #f39c12;
    transform: translateX(-5px);
}

.favorites-section {
    margin-top: 30px;
    padding: 20px;
    background: rgba(22, 33, 62, 0.5);
    border-radius: 15px;
    border: 1px solid rgba(243, 156, 18, 0.2);
}

.favorites-section h3 {
    color: #f39c12;
    margin-bottom: 15px;
    text-align: center;
}

.favorites-list {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
    justify-content: center;
}

.favorite-item {
    background: #27ae60;
    border: none;
    border-radius: 20px;
    padding: 8px 15px;
    color: white;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.3s ease;
}

.favorite-item:hover {
    background: #2ecc71;
    transform: scale(1.05);
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Mobile Anpassungen */
@media (max-width: 600px) {
    .mood-grid {
        grid-template-columns: 1fr;
    }
    
    .suggestion-card {
        padding: 25px;
    }
    
    .suggestion-actions {
        flex-direction: column;
        gap: 15px;
    }
    
    .feedback-buttons {
        justify-content: center;
    }
}

/* Overload-Tracker Styles */
.overload-mini {
    background: linear-gradient(135deg, #16213e 0%, #1a2b4a 100%);
    border-radius: 12px;
    padding: 12px 18px;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    border: 1px solid rgba(243, 156, 18, 0.15);
    cursor: pointer;
    transition: all 0.3s ease;
}

.overload-mini:hover {
    border-color: rgba(243, 156, 18, 0.4);
}

.overload-mini-left {
    display: flex;
    align-items: center;
    gap: 12px;
}

.overload-mini-dot {
    width: 16px;
    height: 16px;
    border-radius: 50%;
    flex-shrink: 0;
    transition: background 0.5s ease;
}

.overload-mini-dot.risk-low { background: #27ae60; }
.overload-mini-dot.risk-medium { background: #f1c40f; animation: pulse 2s infinite; }
.overload-mini-dot.risk-high { background: #e67e22; animation: pulse 1.5s infinite; }
.overload-mini-dot.risk-critical { background: #e74c3c; animation: pulse 1s infinite; }

.overload-mini-label {
    font-size: 14px;
    color: #bbb;
}

.overload-mini-label strong {
    color: #eee;
}

.overload-mini-arrow {
    color: #7f8c8d;
    font-size: 16px;
}

.overload-container {
    max-width: 800px;
    margin: 0 auto;
    padding: 20px;
}

.overload-container h2 {
    text-align: center;
    color: #f39c12;
    margin-bottom: 10px;
}

.overload-subtitle {
    text-align: center;
    color: #bbb;
    font-size: 16px;
    margin-bottom: 30px;
}

/* Ampel */
.overload-ampel {
    background: linear-gradient(135deg, #16213e 0%, #1a2b4a 100%);
    border-radius: 20px;
    padding: 25px;
    margin-bottom: 25px;
    text-align: center;
    border: 1px solid rgba(243, 156, 18, 0.2);
}

.ampel-visual {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 12px;
    margin-bottom: 15px;
}

.ampel-dot {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: #2c3e50;
    transition: all 0.5s ease;
    opacity: 0.3;
}

.ampel-dot.active-green { background: #27ae60; opacity: 1; box-shadow: 0 0 15px rgba(39, 174, 96, 0.5); }
.ampel-dot.active-yellow { background: #f1c40f; opacity: 1; box-shadow: 0 0 15px rgba(241, 196, 15, 0.5); }
.ampel-dot.active-orange { background: #e67e22; opacity: 1; box-shadow: 0 0 15px rgba(230, 126, 34, 0.5); animation: pulse 1.5s infinite; }
.ampel-dot.active-red { background: #e74c3c; opacity: 1; box-shadow: 0 0 20px rgba(231, 76, 60, 0.6); animation: pulse 1s infinite; }

.ampel-label {
    font-size: 20px;
    font-weight: bold;
    margin-bottom: 8px;
}

.ampel-label.level-low { color: #27ae60; }
.ampel-label.level-medium { color: #f1c40f; }
.ampel-label.level-high { color: #e67e22; }
.ampel-label.level-critical { color: #e74c3c; }

.ampel-detail {
    font-size: 14px;
    color: #95a5a6;
}

/* Warnsignale */
.warning-section {
    background: rgba(22, 33, 62, 0.6);
    border-radius: 15px;
    padding: 25px;
    margin-bottom: 25px;
    border: 1px solid rgba(243, 156, 18, 0.2);
}

.warning-section h3 {
    color: #f39c12;
    margin-bottom: 15px;
    text-align: center;
}

.warning-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
    gap: 10px;
}

.warning-btn {
    background: rgba(255,255,255,0.05);
    border: 2px solid transparent;
    border-radius: 12px;
    padding: 12px 15px;
    color: #bbb;
    cursor: pointer;
    font-size: 14px;
    text-align: left;
    transition: all 0.25s ease;
    display: flex;
    align-items: center;
    gap: 10px;
}

.warning-btn:hover {
    background: rgba(255,255,255,0.08);
}

.warning-btn.active {
    background: rgba(231, 76, 60, 0.2);
    border-color: #e74c3c;
    color: #e74c3c;
}

.warning-btn-icon {
    font-size: 22px;
    flex-shrink: 0;
}

/* Gegenma√ünahmen */
.countermeasures {
    background: linear-gradient(135deg, #16213e 0%, #1a2b4a 100%);
    border-radius: 15px;
    padding: 25px;
    margin-bottom: 25px;
    border: 1px solid rgba(243, 156, 18, 0.2);
    display: none;
}

.countermeasures.visible { display: block; animation: fadeIn 0.5s ease; }

.countermeasures h3 {
    color: #f39c12;
    margin-bottom: 15px;
    text-align: center;
}

.countermeasure-item {
    background: rgba(255,255,255,0.05);
    border-radius: 10px;
    padding: 12px 15px;
    margin-bottom: 8px;
    border-left: 3px solid #27ae60;
    font-size: 14px;
    line-height: 1.4;
    color: #ddd;
}

.emergency-mode {
    background: linear-gradient(135deg, #4a1a1a 0%, #2d1111 100%) !important;
    border-color: rgba(231, 76, 60, 0.5) !important;
}

.emergency-mode h3 {
    color: #e74c3c !important;
}

.emergency-mode .countermeasure-item {
    border-left-color: #e74c3c;
}

/* Event-Dokumentation */
.event-doc {
    background: rgba(22, 33, 62, 0.6);
    border-radius: 15px;
    padding: 25px;
    margin-bottom: 25px;
    border: 1px solid rgba(243, 156, 18, 0.2);
}

.event-doc h3 {
    color: #f39c12;
    margin-bottom: 8px;
    text-align: center;
}

.event-doc-subtitle {
    color: #7f8c8d;
    font-size: 13px;
    text-align: center;
    margin-bottom: 20px;
}

.event-type-select {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
    flex-wrap: wrap;
}

.event-type-btn {
    flex: 1;
    min-width: 140px;
    background: rgba(255,255,255,0.05);
    border: 2px solid transparent;
    border-radius: 12px;
    padding: 15px;
    color: #bbb;
    cursor: pointer;
    text-align: center;
    transition: all 0.25s ease;
}

.event-type-btn:hover { background: rgba(255,255,255,0.08); }

.event-type-btn.selected {
    border-color: #f39c12;
    color: #f39c12;
    background: rgba(243, 156, 18, 0.1);
}

.event-type-btn .type-icon { font-size: 28px; display: block; margin-bottom: 6px; }
.event-type-btn .type-name { font-size: 15px; font-weight: bold; display: block; }
.event-type-btn .type-desc { font-size: 12px; color: #7f8c8d; display: block; margin-top: 4px; }

.event-form {
    display: none;
}

.event-form.visible { display: block; animation: fadeIn 0.3s ease; }

.event-form-label {
    color: #f39c12;
    font-size: 14px;
    font-weight: bold;
    margin-bottom: 8px;
    margin-top: 18px;
    display: block;
}

.event-trigger-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-bottom: 10px;
}

.event-trigger-chip {
    background: rgba(255,255,255,0.08);
    border: 1px solid rgba(255,255,255,0.15);
    border-radius: 20px;
    padding: 6px 14px;
    color: #bbb;
    cursor: pointer;
    font-size: 13px;
    transition: all 0.2s ease;
}

.event-trigger-chip:hover { background: rgba(255,255,255,0.12); }

.event-trigger-chip.selected {
    background: rgba(243, 156, 18, 0.2);
    border-color: #f39c12;
    color: #f39c12;
}

.event-freetext {
    width: 100%;
    background: rgba(255,255,255,0.08);
    border: 1px solid rgba(243, 156, 18, 0.2);
    border-radius: 10px;
    padding: 12px;
    color: #eee;
    font-size: 14px;
    resize: vertical;
    min-height: 50px;
    margin-top: 8px;
}

.event-freetext:focus {
    outline: none;
    border-color: #f39c12;
}

.event-duration-select {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
}

.event-duration-chip {
    background: rgba(255,255,255,0.08);
    border: 1px solid rgba(255,255,255,0.15);
    border-radius: 20px;
    padding: 6px 14px;
    color: #bbb;
    cursor: pointer;
    font-size: 13px;
    transition: all 0.2s ease;
}

.event-duration-chip:hover { background: rgba(255,255,255,0.12); }

.event-duration-chip.selected {
    background: rgba(243, 156, 18, 0.2);
    border-color: #f39c12;
    color: #f39c12;
}

.event-save-btn {
    background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
    border: none;
    border-radius: 25px;
    padding: 12px 30px;
    color: white;
    cursor: pointer;
    font-size: 16px;
    font-weight: bold;
    display: block;
    margin: 20px auto 0;
    transition: all 0.3s ease;
}

.event-save-btn:hover {
    transform: scale(1.05);
    box-shadow: 0 5px 15px rgba(46, 204, 113, 0.4);
}

/* Event-Historie */
.event-history {
    background: rgba(22, 33, 62, 0.6);
    border-radius: 15px;
    padding: 25px;
    margin-bottom: 25px;
    border: 1px solid rgba(243, 156, 18, 0.2);
}

.event-history h3 {
    color: #f39c12;
    margin-bottom: 15px;
    text-align: center;
}

.event-history-item {
    background: rgba(255,255,255,0.05);
    border-radius: 12px;
    padding: 15px;
    margin-bottom: 12px;
    border-left: 4px solid #e74c3c;
}

.event-history-item.type-shutdown { border-left-color: #3498db; }
.event-history-item.type-freeze { border-left-color: #9b59b6; }
.event-history-item.type-overload { border-left-color: #e67e22; }

.event-history-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
}

.event-history-type {
    font-weight: bold;
    font-size: 15px;
}

.event-history-meta {
    display: flex;
    align-items: center;
    gap: 10px;
}

.event-history-time {
    color: #95a5a6;
    font-size: 13px;
}

.event-history-body {
    font-size: 13px;
    color: #bbb;
    line-height: 1.4;
}

.event-history-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
    margin-top: 8px;
}

.event-history-tag {
    background: rgba(243, 156, 18, 0.15);
    border-radius: 10px;
    padding: 2px 8px;
    font-size: 11px;
    color: #f39c12;
}

.event-history-delete {
    background: transparent;
    border: none;
    color: #e74c3c;
    cursor: pointer;
    font-size: 16px;
    opacity: 0.7;
    padding: 5px;
    transition: all 0.2s ease;
}

.event-history-delete:hover {
    opacity: 1;
    transform: scale(1.2);
}

.overload-pattern-section {
    background: rgba(22, 33, 62, 0.6);
    border-radius: 15px;
    padding: 25px;
    border: 1px solid rgba(243, 156, 18, 0.2);
}

.overload-pattern-section h3 {
    color: #f39c12;
    margin-bottom: 15px;
    text-align: center;
}

.pattern-insight {
    background: rgba(243, 156, 18, 0.1);
    border: 1px solid rgba(243, 156, 18, 0.3);
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 10px;
    font-size: 14px;
    color: #ddd;
    line-height: 1.4;
}

@media (max-width: 600px) {
    .warning-grid {
        grid-template-columns: 1fr;
    }
    .event-type-select {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
    }
    .event-type-btn {
        min-width: unset;
    }
    .ampel-dot {
        width: 30px;
        height: 30px;
    }
}

/* Dashboard Styles */
.dashboard-container {
    max-width: 800px;
    margin: 0 auto;
    padding: 20px;
}

.dashboard-container h2 {
    text-align: center;
    color: #f39c12;
    margin-bottom: 5px;
}

.dashboard-date {
    text-align: center;
    color: #95a5a6;
    font-size: 14px;
    margin-bottom: 25px;
}

.dashboard-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 15px;
    margin-bottom: 25px;
}

.dashboard-card {
    background: linear-gradient(135deg, #16213e 0%, #1a2b4a 100%);
    border-radius: 15px;
    padding: 20px;
    border: 1px solid rgba(243, 156, 18, 0.15);
    cursor: pointer;
    transition: all 0.3s ease;
}

.dashboard-card:hover {
    border-color: rgba(243, 156, 18, 0.4);
    transform: translateY(-2px);
}

.dashboard-card-label {
    font-size: 12px;
    color: #95a5a6;
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 10px;
}

.dashboard-card-value {
    font-size: 28px;
    font-weight: bold;
    color: #eee;
    margin-bottom: 4px;
}

.dashboard-card-sub {
    font-size: 13px;
    color: #7f8c8d;
}

.dashboard-card.full-width {
    grid-column: 1 / -1;
}

.dashboard-card-value.energy-ok { color: #27ae60; }
.dashboard-card-value.energy-warn { color: #f1c40f; }
.dashboard-card-value.energy-low { color: #e67e22; }
.dashboard-card-value.energy-crit { color: #e74c3c; }

/* Weekly overview */
.dashboard-week {
    background: linear-gradient(135deg, #16213e 0%, #1a2b4a 100%);
    border-radius: 15px;
    padding: 20px;
    border: 1px solid rgba(243, 156, 18, 0.15);
    margin-bottom: 25px;
}

.dashboard-week h3 {
    color: #f39c12;
    margin-bottom: 15px;
    text-align: center;
    font-size: 14px;
}

.week-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 6px;
}

.week-day {
    text-align: center;
    padding: 8px 4px;
    border-radius: 10px;
    background: rgba(255,255,255,0.03);
}

.week-day-name {
    font-size: 11px;
    color: #7f8c8d;
    margin-bottom: 6px;
}

.week-day-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    margin: 0 auto 4px;
    background: #2c3e50;
}

.week-day-dot.dot-green { background: #27ae60; }
.week-day-dot.dot-yellow { background: #f1c40f; }
.week-day-dot.dot-orange { background: #e67e22; }
.week-day-dot.dot-red { background: #e74c3c; }

.week-day-value {
    font-size: 11px;
    color: #bbb;
}

.week-day.today {
    background: rgba(243, 156, 18, 0.15);
    border: 1px solid rgba(243, 156, 18, 0.3);
}

/* Cross-module insights */
.dashboard-insights {
    background: linear-gradient(135deg, #16213e 0%, #1a2b4a 100%);
    border-radius: 15px;
    padding: 20px;
    border: 1px solid rgba(243, 156, 18, 0.15);
}

.dashboard-insights h3 {
    color: #f39c12;
    margin-bottom: 15px;
    text-align: center;
    font-size: 14px;
}

.dashboard-insight-item {
    background: rgba(243, 156, 18, 0.08);
    border-radius: 10px;
    padding: 12px 15px;
    margin-bottom: 8px;
    font-size: 14px;
    color: #ddd;
    line-height: 1.4;
}

.dashboard-no-data {
    color: #7f8c8d;
    font-style: italic;
    text-align: center;
    padding: 15px;
    font-size: 14px;
}

@media (max-width: 600px) {
    .dashboard-grid {
        grid-template-columns: 1fr 1fr;
        gap: 10px;
    }
    .dashboard-card {
        padding: 15px;
    }
    .dashboard-card-value {
        font-size: 22px;
    }
    .week-grid {
        gap: 3px;
    }
}

/* Masking-Tracker Styles */
.masking-container {
    max-width: 800px;
    margin: 0 auto;
    padding: 20px;
}

.masking-container h2 {
    text-align: center;
    color: #f39c12;
    margin-bottom: 10px;
}

.masking-subtitle {
    text-align: center;
    color: #bbb;
    font-size: 16px;
    margin-bottom: 30px;
}

.masking-section {
    background: rgba(22, 33, 62, 0.6);
    border-radius: 15px;
    padding: 25px;
    margin-bottom: 20px;
    border: 1px solid rgba(243, 156, 18, 0.2);
}

.masking-section h3 {
    color: #f39c12;
    margin-bottom: 15px;
    text-align: center;
}

.masking-step-label {
    color: #95a5a6;
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 8px;
    text-align: center;
}

.masking-context-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 10px;
}

.masking-context-btn {
    background: rgba(255,255,255,0.05);
    border: 2px solid transparent;
    border-radius: 12px;
    padding: 14px 12px;
    color: #bbb;
    cursor: pointer;
    text-align: center;
    transition: all 0.25s ease;
    font-size: 14px;
}

.masking-context-btn:hover { background: rgba(255,255,255,0.08); }

.masking-context-btn.selected {
    border-color: #f39c12;
    color: #f39c12;
    background: rgba(243, 156, 18, 0.1);
}

.masking-context-btn .ctx-icon {
    font-size: 24px;
    display: block;
    margin-bottom: 5px;
}

.masking-context-freetext {
    width: 100%;
    background: rgba(255,255,255,0.08);
    border: 1px solid rgba(243, 156, 18, 0.3);
    border-radius: 10px;
    padding: 10px;
    color: #eee;
    font-size: 14px;
    margin-top: 10px;
    display: none;
}

.masking-context-freetext:focus { outline: none; border-color: #f39c12; }
.masking-context-freetext.visible { display: block; animation: fadeIn 0.3s ease; }

.masking-level-section {
    display: none;
}

.masking-level-section.visible { display: block; animation: fadeIn 0.3s ease; }

.masking-level-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 10px;
}

.masking-level-btn {
    background: rgba(255,255,255,0.05);
    border: 2px solid transparent;
    border-radius: 12px;
    padding: 15px 8px;
    color: #bbb;
    cursor: pointer;
    text-align: center;
    transition: all 0.25s ease;
}

.masking-level-btn:hover { background: rgba(255,255,255,0.08); }
.masking-level-btn.selected { color: white; }

.masking-level-btn.selected.level-1 { border-color: #27ae60; background: rgba(39, 174, 96, 0.2); }
.masking-level-btn.selected.level-2 { border-color: #f1c40f; background: rgba(241, 196, 15, 0.2); }
.masking-level-btn.selected.level-3 { border-color: #e67e22; background: rgba(230, 126, 34, 0.2); }
.masking-level-btn.selected.level-4 { border-color: #e74c3c; background: rgba(231, 76, 60, 0.2); }

.masking-level-btn .level-emoji { font-size: 24px; display: block; margin-bottom: 4px; }
.masking-level-btn .level-name { font-size: 13px; font-weight: bold; display: block; }

.masking-reason-section {
    display: none;
}

.masking-reason-section.visible { display: block; animation: fadeIn 0.3s ease; }

.masking-reason-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    justify-content: center;
}

.masking-reason-chip {
    background: rgba(255,255,255,0.08);
    border: 1px solid rgba(255,255,255,0.15);
    border-radius: 20px;
    padding: 8px 14px;
    color: #bbb;
    cursor: pointer;
    font-size: 13px;
    transition: all 0.2s ease;
}

.masking-reason-chip:hover { background: rgba(255,255,255,0.12); }

.masking-reason-chip.selected {
    background: rgba(243, 156, 18, 0.2);
    border-color: #f39c12;
    color: #f39c12;
}

.masking-freetext {
    width: 100%;
    background: rgba(255,255,255,0.08);
    border: 1px solid rgba(243, 156, 18, 0.2);
    border-radius: 10px;
    padding: 12px;
    color: #eee;
    font-size: 14px;
    resize: vertical;
    min-height: 50px;
    margin-top: 15px;
}

.masking-freetext:focus { outline: none; border-color: #f39c12; }

.masking-save-btn {
    background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
    border: none;
    border-radius: 25px;
    padding: 12px 30px;
    color: white;
    cursor: pointer;
    font-size: 16px;
    font-weight: bold;
    display: none;
    margin: 20px auto 0;
    transition: all 0.3s ease;
}

.masking-save-btn.visible { display: block; }
.masking-save-btn:hover { transform: scale(1.05); box-shadow: 0 5px 15px rgba(46, 204, 113, 0.4); }

/* Masking History */
.masking-history-item {
    background: rgba(255,255,255,0.05);
    border-radius: 12px;
    padding: 15px;
    margin-bottom: 10px;
    border-left: 4px solid #95a5a6;
}

.masking-history-item.mlevel-1 { border-left-color: #27ae60; }
.masking-history-item.mlevel-2 { border-left-color: #f1c40f; }
.masking-history-item.mlevel-3 { border-left-color: #e67e22; }
.masking-history-item.mlevel-4 { border-left-color: #e74c3c; }

.masking-history-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 6px;
}

.masking-history-context {
    font-weight: bold;
    font-size: 15px;
    color: #eee;
}

.masking-history-meta {
    display: flex;
    align-items: center;
    gap: 10px;
}

.masking-history-time {
    color: #95a5a6;
    font-size: 13px;
}

.masking-history-delete {
    background: transparent;
    border: none;
    color: #e74c3c;
    cursor: pointer;
    font-size: 16px;
    opacity: 0.7;
    padding: 5px;
    transition: all 0.2s ease;
}

.masking-history-delete:hover { opacity: 1; transform: scale(1.2); }

.masking-history-body {
    font-size: 13px;
    color: #bbb;
    line-height: 1.4;
}

.masking-history-tags {
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
    margin-top: 6px;
}

.masking-history-tag {
    background: rgba(243, 156, 18, 0.15);
    border-radius: 10px;
    padding: 2px 8px;
    font-size: 11px;
    color: #f39c12;
}

.masking-pattern-insight {
    background: rgba(243, 156, 18, 0.1);
    border: 1px solid rgba(243, 156, 18, 0.3);
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 10px;
    font-size: 14px;
    color: #ddd;
    line-height: 1.4;
}

@media (max-width: 600px) {
    .masking-context-grid {
        grid-template-columns: repeat(2, 1fr);
    }
    .masking-level-grid {
        grid-template-columns: repeat(2, 1fr);
    }
}

/* Nachtr√§gliche Erfassung */
.retro-datetime {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-top: 15px;
    margin-bottom: 5px;
    flex-wrap: wrap;
}

.retro-datetime-toggle {
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.15);
    border-radius: 20px;
    padding: 6px 14px;
    color: #95a5a6;
    cursor: pointer;
    font-size: 13px;
    transition: all 0.2s ease;
}

.retro-datetime-toggle:hover { background: rgba(255,255,255,0.08); }

.retro-datetime-toggle.active {
    background: rgba(243, 156, 18, 0.15);
    border-color: #f39c12;
    color: #f39c12;
}

.sensorik-actions .retro-datetime {
    width: 100%;
    justify-content: center;
}

.retro-datetime-input {
    background: rgba(255,255,255,0.08);
    border: 1px solid rgba(243, 156, 18, 0.3);
    border-radius: 10px;
    padding: 8px 12px;
    color: #eee;
    font-size: 14px;
    display: none;
    color-scheme: dark;
}

.retro-datetime-input:focus { outline: none; border-color: #f39c12; }
.retro-datetime-input.visible { display: inline-block; animation: fadeIn 0.3s ease; }

/* Sensorischer Umgebungs-Check Styles */
.sensorik-container {
    max-width: 800px;
    margin: 0 auto;
    padding: 20px;
}

.sensorik-container h2 {
    text-align: center;
    color: #f39c12;
    margin-bottom: 10px;
}

.sensorik-subtitle {
    text-align: center;
    color: #bbb;
    font-size: 16px;
    margin-bottom: 30px;
}

.sensorik-grid {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-bottom: 25px;
}

.sensorik-card {
    background: linear-gradient(135deg, #16213e 0%, #1a2b4a 100%);
    border-radius: 15px;
    padding: 18px 20px;
    border: 1px solid rgba(243, 156, 18, 0.15);
    transition: all 0.3s ease;
}

.sensorik-card-header {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 12px;
}

.sensorik-card-icon {
    font-size: 28px;
    flex-shrink: 0;
}

.sensorik-card-info {
    flex: 1;
}

.sensorik-card-name {
    font-size: 16px;
    font-weight: bold;
    color: #eee;
}

.sensorik-card-hint {
    font-size: 13px;
    color: #7f8c8d;
    margin-top: 2px;
}

.sensorik-levels {
    display: flex;
    gap: 8px;
}

.sensorik-level-btn {
    flex: 1;
    padding: 10px 8px;
    border: 2px solid transparent;
    border-radius: 10px;
    background: rgba(255,255,255,0.05);
    color: #bbb;
    cursor: pointer;
    font-size: 14px;
    text-align: center;
    transition: all 0.25s ease;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 4px;
}

.sensorik-level-btn:hover {
    background: rgba(255,255,255,0.1);
}

.sensorik-level-btn .level-emoji {
    font-size: 20px;
}

.sensorik-level-btn .level-label {
    font-size: 12px;
}

.sensorik-level-btn.selected-ok {
    background: rgba(39, 174, 96, 0.25);
    border-color: #27ae60;
    color: #2ecc71;
}

.sensorik-level-btn.selected-belastend {
    background: rgba(243, 156, 18, 0.25);
    border-color: #f39c12;
    color: #f1c40f;
}

.sensorik-level-btn.selected-zuviel {
    background: rgba(231, 76, 60, 0.25);
    border-color: #e74c3c;
    color: #e74c3c;
}

.sensorik-result {
    background: linear-gradient(135deg, #16213e 0%, #1a2b4a 100%);
    border-radius: 20px;
    padding: 25px;
    margin-bottom: 25px;
    border: 1px solid rgba(243, 156, 18, 0.2);
    text-align: center;
    display: none;
}

.sensorik-result.visible {
    display: block;
    animation: fadeIn 0.5s ease;
}

.sensorik-score {
    font-size: 48px;
    margin-bottom: 5px;
}

.sensorik-score-label {
    font-size: 20px;
    font-weight: bold;
    margin-bottom: 15px;
}

.sensorik-score-label.score-ok { color: #27ae60; }
.sensorik-score-label.score-erhoeht { color: #f39c12; }
.sensorik-score-label.score-hoch { color: #e67e22; }
.sensorik-score-label.score-kritisch { color: #e74c3c; }

.sensorik-bar {
    width: 100%;
    height: 12px;
    background: #2c3e50;
    border-radius: 6px;
    overflow: hidden;
    margin-bottom: 20px;
}

.sensorik-bar-fill {
    height: 100%;
    border-radius: 6px;
    transition: width 0.5s ease, background 0.5s ease;
}

.sensorik-suggestions {
    text-align: left;
    margin-top: 15px;
}

.sensorik-suggestion-item {
    background: rgba(255,255,255,0.05);
    border-radius: 10px;
    padding: 12px 15px;
    margin-bottom: 8px;
    border-left: 3px solid #f39c12;
    font-size: 14px;
    line-height: 1.4;
    color: #ddd;
}

.sensorik-actions {
    display: flex;
    gap: 10px;
    justify-content: center;
    align-items: center;
    flex-wrap: wrap;
    margin-bottom: 25px;
}

.sensorik-save-btn {
    background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
    border: none;
    border-radius: 25px;
    padding: 12px 25px;
    color: white;
    cursor: pointer;
    font-size: 16px;
    font-weight: bold;
    transition: all 0.3s ease;
}

.sensorik-save-btn:hover {
    transform: scale(1.05);
    box-shadow: 0 5px 15px rgba(46, 204, 113, 0.4);
}

.sensorik-reset-btn {
    background: transparent;
    border: 2px solid #7f8c8d;
    border-radius: 25px;
    padding: 10px 20px;
    color: #7f8c8d;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.3s ease;
}

.sensorik-reset-btn:hover {
    border-color: #bdc3c7;
    color: #bdc3c7;
}

.sensorik-history {
    background: rgba(22, 33, 62, 0.6);
    border-radius: 15px;
    padding: 25px;
    border: 1px solid rgba(243, 156, 18, 0.2);
}

.sensorik-history h3 {
    color: #f39c12;
    margin-bottom: 15px;
    text-align: center;
}

.sensorik-history-item {
    background: rgba(255,255,255,0.05);
    border-radius: 10px;
    padding: 15px;
    margin-bottom: 10px;
}

.sensorik-history-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
}

.sensorik-history-time {
    color: #95a5a6;
    font-size: 13px;
}

.sensorik-history-score {
    font-weight: bold;
    font-size: 14px;
}

.sensorik-history-dims {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
}

.sensorik-history-dim {
    font-size: 12px;
    padding: 3px 8px;
    border-radius: 12px;
    background: rgba(255,255,255,0.05);
}

.sensorik-history-dim.dim-ok { color: #27ae60; }
.sensorik-history-dim.dim-belastend { color: #f39c12; }
.sensorik-history-dim.dim-zuviel { color: #e74c3c; }

.sensorik-history-delete {
    background: transparent;
    border: none;
    color: #e74c3c;
    cursor: pointer;
    font-size: 16px;
    opacity: 0.7;
    padding: 5px;
    transition: all 0.2s ease;
}

.sensorik-history-delete:hover {
    opacity: 1;
    transform: scale(1.2);
}

.sensorik-pattern-hint {
    background: rgba(243, 156, 18, 0.1);
    border: 1px solid rgba(243, 156, 18, 0.3);
    border-radius: 10px;
    padding: 15px;
    margin-top: 15px;
    text-align: center;
    font-size: 14px;
    color: #f39c12;
}

@media (max-width: 600px) {
    .sensorik-levels {
        gap: 6px;
    }
    .sensorik-level-btn {
        padding: 8px 4px;
        font-size: 12px;
    }
    .sensorik-level-btn .level-emoji {
        font-size: 18px;
    }
}
  
    </style>
</head>
<body>
    
    <div class="container">
        <h1>üß† Neurodivergenz-Toolkit</h1>
        
        <div class="navigation hidden" id="navigation">
            <button class="nav-btn active" onclick="showPage('tracker')">Tracker</button>
            <button class="nav-btn" onclick="showPage('dashboard')">Dashboard</button>
            <button class="nav-btn" onclick="showPage('stats')">Statistiken</button>
            <button class="nav-btn" onclick="showPage('motivator')">Mini-Motivator</button>
            <button class="nav-btn" onclick="showPage('sensorik')">Sensorik</button>
            <button class="nav-btn" onclick="showPage('overload')">Overload</button>
            <button class="nav-btn" onclick="showPage('masking')">Masking</button>
        </div>
        

        <!-- Tracker Page -->
        <div class="page active" id="trackerPage">
            <div class="morning-checkin" id="morningCheckin">
                <h2>Guten Morgen! Wie viele L√∂ffel hast du heute?</h2>
                <input type="range" min="1" max="10" value="8" class="slider" id="morningSlider">
                <div class="slider-value" id="sliderValue">8 L√∂ffel</div>
                <button class="start-day-btn" onclick="startDay()">Tag starten</button>
            </div>

            <div class="overload-mini hidden" id="overloadMini" onclick="showPage('overload'); document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active')); document.querySelectorAll('.nav-btn').forEach(b=>{if(b.textContent==='Overload')b.classList.add('active')});">
                <div class="overload-mini-left">
                    <div class="overload-mini-dot risk-low" id="overloadMiniDot"></div>
                    <div class="overload-mini-label" id="overloadMiniLabel"><strong>Overload-Risiko:</strong> Stabil</div>
                </div>
                <span class="overload-mini-arrow">‚Üí Details</span>
            </div>

            <div class="energy-display hidden" id="mainDisplay">
                <h2>Deine Energie heute</h2>
                <div class="spoons-container" id="spoonsContainer"></div>
                <div class="energy-number" id="energyNumber">8 / 10</div>
                <div class="energy-status status-good" id="energyStatus">Alles im gr√ºnen Bereich!</div>
                <div class="undo-container" id="undoContainer"></div>
            </div>

            <div class="activities-grid hidden" id="activitiesGrid"></div>

            <div class="history hidden" id="history">
                <h3>Heutiger Verlauf</h3>
                <div id="historyList"></div>
            </div>

            <button class="reset-day hidden" id="resetBtn" onclick="resetDay()">Tag abschlie√üen & Neuer Tag</button>
        </div>
        
        <!-- Dashboard Page -->
        <div class="page" id="dashboardPage">
            <div class="dashboard-container">
                <h2>üìã Dashboard</h2>
                <div class="dashboard-date" id="dashboardDate"></div>

                <div class="dashboard-grid">
                    <div class="dashboard-card" onclick="showPage('tracker'); document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active')); document.querySelectorAll('.nav-btn').forEach(b=>{if(b.textContent==='Tracker')b.classList.add('active')});">
                        <div class="dashboard-card-label">ü•Ñ Energie</div>
                        <div class="dashboard-card-value" id="dashEnergyValue">‚Äì</div>
                        <div class="dashboard-card-sub" id="dashEnergySub">Tag nicht gestartet</div>
                    </div>

                    <div class="dashboard-card" onclick="showPage('overload'); document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active')); document.querySelectorAll('.nav-btn').forEach(b=>{if(b.textContent==='Overload')b.classList.add('active')});">
                        <div class="dashboard-card-label">‚ö° Overload-Risiko</div>
                        <div class="dashboard-card-value" id="dashOverloadValue">‚Äì</div>
                        <div class="dashboard-card-sub" id="dashOverloadSub">Keine Warnsignale</div>
                    </div>

                    <div class="dashboard-card" onclick="showPage('sensorik'); document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active')); document.querySelectorAll('.nav-btn').forEach(b=>{if(b.textContent==='Sensorik')b.classList.add('active')});">
                        <div class="dashboard-card-label">üëÅÔ∏è Sensorik</div>
                        <div class="dashboard-card-value" id="dashSensorikValue">‚Äì</div>
                        <div class="dashboard-card-sub" id="dashSensorikSub">Kein Check heute</div>
                    </div>

                    <div class="dashboard-card" onclick="showPage('masking'); document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active')); document.querySelectorAll('.nav-btn').forEach(b=>{if(b.textContent==='Masking')b.classList.add('active')});">
                        <div class="dashboard-card-label">üé≠ Kompensation</div>
                        <div class="dashboard-card-value" id="dashMaskingValue">‚Äì</div>
                        <div class="dashboard-card-sub" id="dashMaskingSub">Heute keine Eintr√§ge</div>
                    </div>
                </div>

                <div class="dashboard-week">
                    <h3>üìÖ Letzte 7 Tage ‚Äì Gesamtbelastung</h3>
                    <div class="week-grid" id="dashWeekGrid"></div>
                </div>

                <div class="dashboard-insights">
                    <h3>üîç Zusammenh√§nge</h3>
                    <div id="dashInsightsList"></div>
                </div>
            </div>
        </div>
        
        <!-- Statistics Page -->
        <div class="page" id="statsPage">
            <div class="stats-container">
                <h2>Deine Energie-Statistiken</h2>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Getrackte Tage</h3>
                        <div class="stat-value" id="totalDays">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>√ò Startenergie</h3>
                        <div class="stat-value" id="avgStart">-</div>
                    </div>
                    <div class="stat-card">
                        <h3>√ò Endenergie</h3>
                        <div class="stat-value" id="avgEnd">-</div>
                    </div>
                </div>

                <div class="insights">
                    <h3>Erkenntnisse</h3>
                    <div id="insightsList"></div>
                </div>

                <div class="top-activities">
                    <div class="activity-stat drain">
                        <h4>Gr√∂√üte Energier√§uber</h4>
                        <div id="topDrains"></div>
                    </div>
                    <div class="activity-stat gain">
                        <h4>Beste Energiequellen</h4>
                        <div id="topGains"></div>
                    </div>
                </div>

                <div class="export-import">
                    <button class="export-btn" onclick="exportData()">üì• Daten exportieren</button>
                    <button class="import-btn" onclick="document.getElementById('importInput').click()">üì§ Daten importieren</button>
                    <input type="file" id="importInput" class="import-input" accept=".json" onchange="importData(event)">
                </div>
            </div>
        </div>
      
        <!-- Mini-Motivator Page -->
        <div class="page" id="motivatorPage">
            <div class="motivator-container">
                <h2>üß† Mini-Motivator</h2>
                <p class="motivator-subtitle">Wie f√ºhlst du dich gerade?</p>
                
                <!-- Gef√ºhlszust√§nde -->
                <div class="mood-grid" id="moodGrid">
                    <button class="mood-btn" onclick="selectMood('√ºberfordert', 'üòµ')">
                        <span class="mood-icon">üòµ</span>
                        <span class="mood-name">√úberfordert</span>
                        <span class="mood-desc">Ich wei√ü nicht, wo ich anfangen soll</span>
                    </button>
                    
                    <button class="mood-btn" onclick="selectMood('lethargisch', 'üò©')">
                        <span class="mood-icon">üò©</span>
                        <span class="mood-name">Lethargisch</span>
                        <span class="mood-desc">Ich will was tun, aber komm nicht in Gang</span>
                    </button>
                    
                    <button class="mood-btn" onclick="selectMood('verknotet', 'üåÄ')">
                        <span class="mood-icon">üåÄ</span>
                        <span class="mood-name">Verknotet</span>
                        <span class="mood-desc">3 Gedanken gleichzeitig, keine Klarheit</span>
                    </button>
                    
                    <button class="mood-btn" onclick="selectMood('unruhig', '‚ö°')">
                        <span class="mood-icon">‚ö°</span>
                        <span class="mood-name">Unruhig</span>
                        <span class="mood-desc">Rastlos, aber kann nichts greifen</span>
                    </button>
                    
                    <button class="mood-btn" onclick="selectMood('blockiert', 'üò∂')">
                        <span class="mood-icon">üò∂</span>
                        <span class="mood-name">Blockiert</span>
                        <span class="mood-desc">Sollte was tun, kann's nicht ansteuern</span>
                    </button>
                    
                    <button class="mood-btn" onclick="selectMood('√ºberreizt', 'üßØ')">
                        <span class="mood-icon">üßØ</span>
                        <span class="mood-name">√úberreizt</span>
                        <span class="mood-desc">Zu viele Eindr√ºcke, brauch R√ºckzug</span>
                    </button>
                    
                    <button class="mood-btn" onclick="selectMood('prokrastinierend', 'ü´†')">
                        <span class="mood-icon">ü´†</span>
                        <span class="mood-name">Prokrastinierend</span>
                        <span class="mood-desc">Tue alles au√üer dem Wichtigen</span>
                    </button>
                    
                    <button class="mood-btn" onclick="selectMood('hyperfokussiert', 'üöÄ')">
                        <span class="mood-icon">üöÄ</span>
                        <span class="mood-name">Hyperfokussiert</span>
                        <span class="mood-desc">Tief drin, vergesse alles drumrum</span>
                    </button>
                    
                    <button class="mood-btn" onclick="selectMood('verloren', '‚òÅÔ∏è')">
                        <span class="mood-icon">‚òÅÔ∏è</span>
                        <span class="mood-name">Verloren</span>
                        <span class="mood-desc">Wei√ü nicht, was ich brauche</span>
                    </button>
                    
                    <button class="mood-btn" onclick="selectMood('taub', 'üßä')">
                        <span class="mood-icon">üßä</span>
                        <span class="mood-name">Taub</span>
                        <span class="mood-desc">F√ºhle nichts / bin eingefroren</span>
                    </button>
                    
                    <button class="mood-btn unknown-btn" onclick="selectMood('unbekannt', 'ü§∑')">
                        <span class="mood-icon">ü§∑</span>
                        <span class="mood-name">Ich wei√ü es nicht</span>
                        <span class="mood-desc">Schlag mir einfach was Sanftes vor</span>
                    </button>
                </div>
                
                <!-- Suggestion Display -->
                <div class="suggestion-display hidden" id="suggestionDisplay">
                    <div class="suggestion-card">
                        <h3>üí´ Versuch doch mal:</h3>
                        <div class="suggestion-content" id="suggestionContent"></div>
                        
                        <div class="suggestion-actions">
                            <button class="try-again-btn" onclick="getNewSuggestion()">
                                üîÑ Anderer Vorschlag
                            </button>
                            <div class="feedback-buttons">
                                <button class="feedback-btn good" onclick="giveFeedback(true)" title="Hat geholfen">
                                    üëç
                                </button>
                                <button class="feedback-btn bad" onclick="giveFeedback(false)" title="Hat nicht geholfen">
                                    üëé
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <button class="back-to-moods-btn" onclick="backToMoods()">
                        ‚Üê Zur√ºck zu den Gef√ºhlen
                    </button>
                </div>
                
                <!-- Quick Favorites (wenn vorhanden) -->
                <div class="favorites-section hidden" id="favoritesSection">
                    <h3>‚≠ê Deine Favoriten</h3>
                    <div class="favorites-list" id="favoritesList"></div>
                </div>
            </div>
        </div>

        <!-- Overload-Tracker Page -->
        <div class="page" id="overloadPage">
            <div class="overload-container">
                <h2>‚ö° Overload-Tracker</h2>
                <p class="overload-subtitle">Fr√ºhwarnung & Dokumentation</p>
                
                <!-- Ampel -->
                <div class="overload-ampel">
                    <div class="ampel-visual">
                        <div class="ampel-dot" id="ampelGreen"></div>
                        <div class="ampel-dot" id="ampelYellow"></div>
                        <div class="ampel-dot" id="ampelOrange"></div>
                        <div class="ampel-dot" id="ampelRed"></div>
                    </div>
                    <div class="ampel-label level-low" id="ampelLabel">Stabil</div>
                    <div class="ampel-detail" id="ampelDetail">Keine akuten Warnsignale</div>
                </div>
                
                <!-- Warnsignale -->
                <div class="warning-section">
                    <h3>üö® Warnsignale ‚Äì was merkst du gerade?</h3>
                    <div class="warning-grid" id="warningGrid"></div>
                </div>
                
                <!-- Gegenma√ünahmen -->
                <div class="countermeasures" id="countermeasures">
                    <h3 id="countermeasuresTitle">üí° Was du jetzt tun kannst</h3>
                    <div id="countermeasuresList"></div>
                </div>
                
                <!-- Event-Dokumentation -->
                <div class="event-doc">
                    <h3>üìù Overload dokumentieren</h3>
                    <p class="event-doc-subtitle">Wenn es passiert ist ‚Äì festhalten, was war</p>
                    
                    <div class="event-type-select" id="eventTypeSelect">
                        <button class="event-type-btn" onclick="selectEventType('overload')">
                            <span class="type-icon">‚ö°</span>
                            <span class="type-name">Overload</span>
                            <span class="type-desc">Zu viel, System am Limit</span>
                        </button>
                        <button class="event-type-btn" onclick="selectEventType('meltdown')">
                            <span class="type-icon">üåã</span>
                            <span class="type-name">Meltdown</span>
                            <span class="type-desc">Reize explodieren nach au√üen</span>
                        </button>
                        <button class="event-type-btn" onclick="selectEventType('shutdown')">
                            <span class="type-icon">üßä</span>
                            <span class="type-name">Shutdown</span>
                            <span class="type-desc">System f√§hrt runter, Stille</span>
                        </button>
                        <button class="event-type-btn" onclick="selectEventType('freeze')">
                            <span class="type-icon">ü´•</span>
                            <span class="type-name">Freeze</span>
                            <span class="type-desc">Eingefroren, kann nicht handeln</span>
                        </button>
                    </div>
                    
                    <div class="event-form" id="eventForm">
                        <span class="event-form-label">Was war vorher? (Trigger)</span>
                        <div class="event-trigger-grid" id="eventTriggerGrid"></div>
                        
                        <span class="event-form-label">Welche Warnsignale hast du im Nachhinein erkannt?</span>
                        <div class="event-trigger-grid" id="eventWarningGrid"></div>
                        
                        <span class="event-form-label">Was hat geholfen?</span>
                        <div class="event-trigger-grid" id="eventHelpedGrid"></div>
                        
                        <span class="event-form-label">Erholungsdauer</span>
                        <div class="event-duration-select" id="eventDurationSelect"></div>
                        
                        <span class="event-form-label">Notizen (optional)</span>
                        <textarea class="event-freetext" id="eventFreetext" placeholder="Was m√∂chtest du dir merken?" maxlength="300"></textarea>
                        
                        <button class="event-save-btn" onclick="saveOverloadEvent()">üíæ Speichern</button>
                    </div>
                </div>
                
                <!-- Event-Historie -->
                <div class="event-history" id="eventHistory">
                    <h3>üìä Vergangene Overloads</h3>
                    <div id="eventHistoryList"></div>
                </div>
                
                <!-- Muster -->
                <div class="overload-pattern-section" id="overloadPatterns">
                    <h3>üîç Muster & Erkenntnisse</h3>
                    <div id="overloadPatternList"></div>
                </div>
            </div>
        </div>

        <!-- Masking-Tracker Page -->
        <div class="page" id="maskingPage">
            <div class="masking-container">
                <h2>üé≠ Kompensations-Tracker</h2>
                <p class="masking-subtitle">Muster erkennen, nicht bewerten</p>

                <!-- Neuer Eintrag -->
                <div class="masking-section">
                    <h3>üìù Situation erfassen</h3>

                    <p class="masking-step-label">Schritt 1 ‚Äì Kontext</p>
                    <div class="masking-context-grid" id="maskingContextGrid"></div>
                    <input type="text" class="masking-context-freetext" id="maskingContextFreetext" placeholder="Situation beschreiben..." maxlength="80">

                    <div class="masking-level-section" id="maskingLevelSection">
                        <p class="masking-step-label" style="margin-top:20px;">Schritt 2 ‚Äì Kompensationsaufwand</p>
                        <div class="masking-level-grid" id="maskingLevelGrid"></div>
                    </div>

                    <div class="masking-reason-section" id="maskingReasonSection">
                        <p class="masking-step-label" style="margin-top:20px;">Schritt 3 ‚Äì Was hat es teuer gemacht? (optional, max. 3)</p>
                        <div class="masking-reason-grid" id="maskingReasonGrid"></div>
                    </div>

                    <textarea class="masking-freetext" id="maskingFreetext" placeholder="Notizen (optional)" maxlength="300" style="display:none;"></textarea>

                    <div class="retro-datetime" id="maskingRetroSection" style="display:none;">
                        <button class="retro-datetime-toggle" id="maskingRetroToggle" onclick="toggleRetroDatetime('masking')">üïê Jetzt</button>
                        <input type="datetime-local" class="retro-datetime-input" id="maskingRetroInput">
                    </div>

                    <button class="masking-save-btn" id="maskingSaveBtn" onclick="saveMaskingEntry()">üíæ Speichern</button>
                </div>

                <!-- Historie -->
                <div class="masking-section" id="maskingHistory">
                    <h3>üìä Vergangene Eintr√§ge</h3>
                    <div id="maskingHistoryList"></div>
                </div>

                <!-- Muster -->
                <div class="masking-section" id="maskingPatterns">
                    <h3>üîç Muster & Erkenntnisse</h3>
                    <div id="maskingPatternList"></div>
                </div>
            </div>
        </div>

        <!-- Sensorischer Umgebungs-Check Page -->
        <div class="page" id="sensorikPage">
            <div class="sensorik-container">
                <h2>üå°Ô∏è Sensorischer Umgebungs-Check</h2>
                <p class="sensorik-subtitle">Wie f√ºhlt sich deine Umgebung gerade an?</p>
                
                <div class="sensorik-grid" id="sensorikGrid"></div>
                
                <!-- Ergebnis -->
                <div class="sensorik-result" id="sensorikResult">
                    <div class="sensorik-score" id="sensorikScore"></div>
                    <div class="sensorik-score-label" id="sensorikScoreLabel"></div>
                    <div class="sensorik-bar">
                        <div class="sensorik-bar-fill" id="sensorikBarFill"></div>
                    </div>
                    <div class="sensorik-suggestions" id="sensorikSuggestions"></div>
                </div>
                
                <!-- Aktionen -->
                <div class="sensorik-actions" id="sensorikActions" style="display:none;">
                    <div class="retro-datetime">
                        <button class="retro-datetime-toggle" id="sensorikRetroToggle" onclick="toggleRetroDatetime('sensorik')">üïê Jetzt</button>
                        <input type="datetime-local" class="retro-datetime-input" id="sensorikRetroInput">
                    </div>
                    <button class="sensorik-save-btn" onclick="saveSensorikCheck()">üíæ Check speichern</button>
                    <button class="sensorik-reset-btn" onclick="resetSensorikCheck()">Zur√ºcksetzen</button>
                </div>
                
                <!-- Verlauf -->
                <div class="sensorik-history" id="sensorikHistory">
                    <h3>üìä Letzte Checks</h3>
                    <div id="sensorikHistoryList">
                        <p style="color: #95a5a6; text-align: center; font-style: italic;">Noch keine Checks gespeichert</p>
                    </div>
                    <div id="sensorikPatternHint"></div>
                </div>
            </div>
        </div>

    </div> <!-- Ende container -->
        

 
    </div>

    <script>
        let currentEnergy = 8;
        let maxEnergy = 10;
        let dayStarted = false;
        let history = [];
        let currentDay = null;
        let allDays = [];
        let lastAction = null;
        let undoTimeout = null;

        // Angepasste Aktivit√§ten f√ºr Neurodivergenz-Toolkit
const activities = [
    { name: 'Ablehnung verarbeiten', cost: -4, icon: 'üíî' },
    { name: 'Accountability Buddy nutzen', cost: 3, icon: 'ü§ù' },
    { name: 'ND-Content lesen/schauen', cost: 1, icon: 'üìö' },
    { name: 'ND erkl√§ren / √ºber sich reden', cost: -2, icon: 'üó£Ô∏è' },
    { name: 'Anfangen (Initiation)', cost: -2, icon: 'üö¶' },
    { name: 'Arzttermin', cost: -4, icon: 'üè•' },
    { name: 'Aufh√∂ren / stoppen', cost: -2, icon: 'üõë' },
    { name: 'Aufschub √ºberwunden', cost: 3, icon: 'üöÄ' },
    { name: 'Bewusst atmen', cost: 1, icon: 'üå¨Ô∏è' },
    { name: 'Chaos ignoriert (bewusst)', cost: 1, icon: 'üôà' },
    { name: 'Deadline', cost: -5, icon: '‚è∞' },
    { name: 'Dinge finden / suchen', cost: -2, icon: 'üîç' },
    { name: 'Eine Sache bewusst nicht getan', cost: 2, icon: 'üö´' },
    { name: 'E-Mails', cost: -1, icon: 'üìß' },
    { name: 'Entscheidungen treffen', cost: -2, icon: 'ü§î' },
    { name: 'Entscheidungen vermeiden (aufschieben)', cost: -1, icon: 'üôà' },
    { name: 'Entspannung', cost: 4, icon: 'üßò' },
    { name: 'Etwas losgelassen, was ich ‚Äûsollte"', cost: 2, icon: 'ü´ß' },
    { name: 'Etwas nicht zu Ende gebracht', cost: -1, icon: 'üöß' },
    { name: 'Fokusarbeit', cost: -2, icon: 'üíª' },
    { name: 'Geruchsreize (unangenehm)', cost: -1, icon: 'üëÉ' },
    { name: 'Haushalt', cost: -1, icon: 'üè†' },
    { name: 'Hintergrundger√§usche (viele)', cost: -2, icon: 'üîâ' },
    { name: 'Hyperfokus (Arbeit)', cost: 2, icon: 'üöÄ' },
    { name: 'Hyperfokus (privat, moderat)', cost: 4, icon: '‚ú®' },
    { name: 'Hyperfokus (privat, intensiv)', cost: -3, icon: '‚ú®' },
    { name: 'Klarheit / Aha-Moment', cost: 2, icon: 'üí°' },
    { name: 'Kleinkram erledigt (Mini-To-Dos)', cost: -2, icon: 'üßæ' },
    { name: 'Kochen (einfach)', cost: 1, icon: 'üç≥' },
    { name: 'Kochen (komplex)', cost: -2, icon: 'üë®‚Äçüç≥' },
    { name: 'Konflikt', cost: -4, icon: '‚ö°' },
    { name: 'Kontakt gesucht (kurz)', cost: 2, icon: 'üì®' },
    { name: 'Kreative T√§tigkeit', cost: 3, icon: 'üé®' },
    { name: 'Kritik verarbeiten', cost: -3, icon: '‚öñÔ∏è' },
    { name: 'Kurzes spontanes Tanzen', cost: 3, icon: 'üíÉ' },
    { name: 'Lichtreize (hell, grell, flackernd)', cost: -2, icon: 'üí°' },
    { name: 'Masking / sich ‚Äûanpassen"', cost: -4, icon: 'üé≠' },
    { name: 'Meeting', cost: -4, icon: 'üë•' },
    { name: 'Mich an etwas Sch√∂nes erinnert', cost: 2, icon: 'üì∏' },
    { name: 'Mir verziehen, dass ich Pause gemacht habe', cost: 3, icon: 'üß°' },
    { name: 'Mich nicht verglichen', cost: 2, icon: 'üö´' },
    { name: 'Mit jemandem gelacht', cost: 3, icon: 'üòÇ' },
    { name: 'Multitasking / Kontexte wechseln', cost: -2, icon: 'üîÄ' },
    { name: 'Musik h√∂ren', cost: 3, icon: 'üéµ' },
    { name: 'Nach Hilfe gefragt', cost: 3, icon: 'üôã' },
    { name: 'Nichts geschafft (trotz M√ºhe)', cost: -4, icon: 'üå´Ô∏è' },
    { name: 'Ordnung schaffen', cost: -2, icon: 'üßπ' },
    { name: 'Organisation', cost: -2, icon: 'üìÅ' },
    { name: 'Overthinking / Ruminieren', cost: -2, icon: 'üîÑ' },
    { name: 'Papierkram', cost: -4, icon: 'üìÑ' },
    { name: 'Pause', cost: 2, icon: '‚òï' },
    { name: 'Plan√§nderung', cost: -3, icon: 'üîÑ' },
    { name: 'Power-Nap', cost: 2, icon: 'üò¥' },
    { name: 'Priorisieren', cost: -1, icon: 'üìä' },
    { name: 'Rechnungen zahlen / Fristen beachten', cost: -3, icon: 'üí∏' },
    { name: 'Routine√§nderung', cost: -4, icon: 'üîÄ' },
    { name: 'Routineaufgaben', cost: -3, icon: 'üìã' },
    { name: 'Sache angefangen, ohne sie fertig zu m√ºssen', cost: 1, icon: 'üß∂' },
    { name: 'Scroll-Falle / Dopamin-Dump', cost: -3, icon: 'üì±' },
    { name: 'Selbstkritik / Shame Spiral', cost: -4, icon: 'üï≥Ô∏è' },
    { name: 'Selbstmitgef√ºhl √ºben', cost: 2, icon: 'üíñ' },
    { name: 'Selbststimulierung bewusst nutzen', cost: 2, icon: 'üéõÔ∏è' },
    { name: 'Small Talk', cost: -5, icon: 'üí¨' },
    { name: 'Soziales Tiefgespr√§ch', cost: -2, icon: 'üó®Ô∏è' },
    { name: 'Soziale Interaktion (Arbeit)', cost: -6, icon: 'üó£Ô∏è' },
    { name: 'Soziale Interaktion (Privat)', cost: -1, icon: '‚òï' },
    { name: 'Spaziergang', cost: 3, icon: 'üö∂' },
    { name: 'Special Interest Zeit', cost: 5, icon: '‚≠ê' },
    { name: 'Spoons bewusst eingesetzt', cost: 2, icon: 'ü•Ñ' },
    { name: 'Spontane Anfrage/Unterbrechung', cost: -3, icon: '‚ùó' },
    { name: 'Sport (anstrengend)', cost: -1, icon: 'üí™' },
    { name: 'Sport (leicht)', cost: 3, icon: 'üßò‚Äç‚ôÄÔ∏è' },
    { name: 'Stretching / Dehnen', cost: 2, icon: 'ü§∏' },
    { name: 'Tagtr√§umen (geplant)', cost: 2, icon: '‚òÅÔ∏è' },
    { name: 'Telefonieren', cost: -3, icon: 'üìû' },
    { name: 'To-Do-Liste erstellt', cost: 1, icon: 'üìù' },
    { name: '√úberlappende Gespr√§che', cost: -3, icon: 'üó£Ô∏è' },
    { name: 'Unterbrechung', cost: -3, icon: 'üö´' },
    { name: 'Warten / Leerlauf', cost: -3, icon: '‚è≥' },
    { name: 'Zeit mit Tieren', cost: 3, icon: 'üêæ' },
    { name: 'Zweisamkeit ohne reden', cost: 2, icon: 'ü§ù' }
];

        // Slider functionality
        const slider = document.getElementById('morningSlider');
        const sliderValue = document.getElementById('sliderValue');
        
        slider.addEventListener('input', function() {
            sliderValue.textContent = `${this.value} L√∂ffel`;
        });

        function startDay() {
            maxEnergy = parseInt(slider.value);
            currentEnergy = maxEnergy;
            dayStarted = true;
            history = [];
            
            // Create new day record
            currentDay = {
                date: new Date().toISOString().split('T')[0],
                dayOfWeek: new Date().getDay(),
                startEnergy: maxEnergy,
                endEnergy: currentEnergy,
                activities: []
            };
            
            document.getElementById('morningCheckin').classList.add('hidden');
            document.getElementById('mainDisplay').classList.remove('hidden');
            document.getElementById('activitiesGrid').classList.remove('hidden');
            document.getElementById('history').classList.remove('hidden');
            document.getElementById('resetBtn').classList.remove('hidden');
            document.getElementById('navigation').classList.remove('hidden');
            document.getElementById('overloadMini').classList.remove('hidden');
            
            updateDisplay();
            renderActivities();
            saveToLocalStorage();
        }

        function updateDisplay() {
            const spoonsContainer = document.getElementById('spoonsContainer');
            const energyNumber = document.getElementById('energyNumber');
            const energyStatus = document.getElementById('energyStatus');
            
            // Clear and update spoons
            spoonsContainer.innerHTML = '';
            for (let i = 0; i < maxEnergy; i++) {
                const spoon = document.createElement('span');
                spoon.className = 'spoon';
                spoon.textContent = 'ü•Ñ';
                if (i >= currentEnergy) {
                    spoon.classList.add('empty');
                } else {
                    spoon.classList.add('full');
                }
                spoonsContainer.appendChild(spoon);
            }
            
            // Update number
            energyNumber.textContent = `${currentEnergy} / ${maxEnergy}`;
            
            // Update status
            energyStatus.classList.remove('status-good', 'status-warning', 'status-critical');
            if (currentEnergy <= 2) {
                energyStatus.classList.add('status-critical');
                energyStatus.textContent = '‚ö†Ô∏è Kritisch! Zeit f√ºr eine Pause!';
            } else if (currentEnergy <= 4) {
                energyStatus.classList.add('status-warning');
                energyStatus.textContent = '‚ö° Vorsicht - Energie wird knapp!';
            } else {
                energyStatus.classList.add('status-good');
                energyStatus.textContent = '‚úÖ Alles im gr√ºnen Bereich!';
            }
            
            // Update current day end energy
            if (currentDay) {
                currentDay.endEnergy = currentEnergy;
            }
            
            // Update overload mini-ampel
            if (typeof updateOverloadMini === 'function') {
                updateOverloadMini();
            }
        }

        function renderActivities() {
    const grid = document.getElementById('activitiesGrid');
    grid.innerHTML = '';
    
    // NEUE ADHS-OPTIMIERUNG: Nur passende Aktivit√§ten zeigen
    const relevantActivities = getRelevantActivities();
    
    relevantActivities.forEach(activity => {
        const btn = document.createElement('button');
        btn.className = 'activity-btn';
        
        // Color coding based on energy cost
        if (activity.cost > 0) {
            btn.classList.add('energy-gain');
        } else if (activity.cost >= -2) {
            btn.classList.add('energy-drain-low');
        } else if (activity.cost >= -4) {
            btn.classList.add('energy-drain-medium');
        } else {
            btn.classList.add('energy-drain-high');
        }
        
        btn.innerHTML = `
            <span style="font-size: 30px">${activity.icon}</span>
            <span>${activity.name}</span>
            <span class="energy-cost">${activity.cost > 0 ? '+' : ''}${activity.cost} ü•Ñ</span>
        `;
        
        btn.onclick = () => doActivity(activity);
        grid.appendChild(btn);
    });
    
    // Button um alle Aktivit√§ten zu zeigen
    const showAllBtn = document.createElement('button');
    showAllBtn.className = 'activity-btn';
    showAllBtn.style.cssText = 'background: #7f8c8d; opacity: 0.8;';
    showAllBtn.innerHTML = `
        <span style="font-size: 20px">üìã</span>
        <span>Alle anzeigen</span>
        <span style="font-size: 12px">${activities.length} Aktivit√§ten</span>
    `;
    showAllBtn.onclick = () => showAllActivities();
    grid.appendChild(showAllBtn);
}

// NEUE FUNKTION: Relevante Aktivit√§ten ausw√§hlen
function getRelevantActivities() {
    const currentHour = new Date().getHours();
    let filtered = [];
    
    // Bei sehr wenig Energie: Nur Notfall-Aktivit√§ten
    if (currentEnergy <= 2) {
        filtered = activities.filter(a => 
            a.cost > 0 || // Energie-gewinnend
            a.name.includes('Pause') ||
            a.name.includes('atmen') ||
            a.name.includes('Entspannung') ||
            a.name.includes('Wasser') ||
            a.name.includes('Power-Nap')
        ).slice(0, 4);
        
        // Notfall-Option hinzuf√ºgen
        filtered.push({ 
            name: 'Einfach nichts tun', 
            cost: 0, 
            icon: 'ü§ç' 
        });
        
        return filtered;
    }
    
    // Morgens (6-12): Energie-aufbauende Aktivit√§ten
    if (currentHour >= 6 && currentHour < 12) {
        filtered = activities.filter(a => 
            a.cost > 0 || // Positive Energie
            a.cost >= -1 || // Leichte Aktivit√§ten
            a.name.includes('Musik') ||
            a.name.includes('Spaziergang') ||
            a.name.includes('Sport (leicht)')
        ).slice(0, 6);
    }
    // Mittags (12-17): Produktive aber machbare Sachen
    else if (currentHour >= 12 && currentHour < 17) {
        filtered = activities.filter(a => 
            a.cost >= -3 && // Nicht zu anstrengend
            !a.name.includes('Socializing (Arbeit)') // Keine schweren sozialen Sachen
        ).slice(0, 6);
    }
    // Abends (17-22): Entspannung und Abschalten
    else if (currentHour >= 17 && currentHour < 22) {
        filtered = activities.filter(a => 
            a.cost > 0 || // Energie-aufbauend
            a.name.includes('Entspannung') ||
            a.name.includes('Musik') ||
            a.name.includes('Zweisamkeit') ||
            a.name.includes('Tiere')
        ).slice(0, 6);
    }
    // Nachts: Nur Ruhe-Aktivit√§ten
    else {
        filtered = activities.filter(a => 
            a.cost > 0 ||
            a.name.includes('Entspannung') ||
            a.name.includes('Power-Nap') ||
            a.name.includes('atmen')
        ).slice(0, 4);
    }
    
    return filtered.length > 0 ? filtered : activities.slice(0, 6);
}

// NEUE FUNKTION: Alle Aktivit√§ten anzeigen
function showAllActivities() {
    const grid = document.getElementById('activitiesGrid');
    grid.innerHTML = '';
    
    // Zur√ºck-Button
    const backBtn = document.createElement('button');
    backBtn.className = 'activity-btn';
    backBtn.style.cssText = 'background: #3498db;';
    backBtn.innerHTML = `
        <span style="font-size: 20px">‚Üê</span>
        <span>Zur√ºck zu Empfehlungen</span>
    `;
    backBtn.onclick = () => renderActivities();
    grid.appendChild(backBtn);
    
    // Alle Aktivit√§ten anzeigen (original Code)
    activities.forEach(activity => {
        const btn = document.createElement('button');
        btn.className = 'activity-btn';
        
        if (activity.cost > 0) {
            btn.classList.add('energy-gain');
        } else if (activity.cost >= -2) {
            btn.classList.add('energy-drain-low');
        } else if (activity.cost >= -4) {
            btn.classList.add('energy-drain-medium');
        } else {
            btn.classList.add('energy-drain-high');
        }
        
        btn.innerHTML = `
            <span style="font-size: 30px">${activity.icon}</span>
            <span>${activity.name}</span>
            <span class="energy-cost">${activity.cost > 0 ? '+' : ''}${activity.cost} ü•Ñ</span>
        `;
        
        btn.onclick = () => doActivity(activity);
        grid.appendChild(btn);
    });
}


        function doActivity(activity) {
            const previousEnergy = currentEnergy;
            const newEnergy = currentEnergy + activity.cost;
            
            // Don't go below 0 or above max
            currentEnergy = Math.max(0, Math.min(maxEnergy, newEnergy));
            
            // Add to history
            const time = new Date().toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
            const activityRecord = {
                time: time,
                activity: activity.name,
                cost: activity.cost,
                icon: activity.icon
            };
            
            history.unshift(activityRecord);
            
            // Add to current day
            if (currentDay) {
                currentDay.activities.push(activityRecord);
            }
            
            // Store last action for undo
            lastAction = {
                activity: activityRecord,
                previousEnergy: previousEnergy
            };
            
            // Show undo button
            showUndoButton();
            
            updateDisplay();
            updateHistory();
            saveToLocalStorage();
            
            // Alert if energy is critical
            if (currentEnergy <= 2 && activity.cost < 0) {
                setTimeout(() => {
                    alert('‚ö†Ô∏è Deine Energie ist kritisch niedrig.\n\nDu musst jetzt nichts mehr schaffen.\nWas auch immer noch offen ist ‚Äì es kann warten.');
                }, 100);
            }
        }

        function showUndoButton() {
            // Clear existing timeout
            if (undoTimeout) {
                clearTimeout(undoTimeout);
            }
            
            const undoContainer = document.getElementById('undoContainer');
            undoContainer.innerHTML = '<button class="undo-btn" onclick="undoLastAction()">‚Ü©Ô∏è R√ºckg√§ngig</button>';
            
            // Remove button after 5 seconds
            undoTimeout = setTimeout(() => {
                undoContainer.innerHTML = '';
                lastAction = null;
            }, 5000);
        }

        function undoLastAction() {
            if (!lastAction) return;
            
            // Restore previous energy
            currentEnergy = lastAction.previousEnergy;
            
            // Remove from history
            history.shift();
            
            // Remove from current day
            if (currentDay && currentDay.activities.length > 0) {
                currentDay.activities.pop();
            }
            
            // Clear undo button
            document.getElementById('undoContainer').innerHTML = '';
            clearTimeout(undoTimeout);
            lastAction = null;
            
            // Update displays
            updateDisplay();
            updateHistory();
            saveToLocalStorage();
        }

        function updateHistory() {
            const historyList = document.getElementById('historyList');
            historyList.innerHTML = '';
            
            history.slice(0, 10).forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'history-item';
                div.innerHTML = `
                    <div class="history-item-content">
                        <span>${item.icon} ${item.time} - ${item.activity}</span>
                    </div>
                    <div class="history-item-actions">
                        <span style="color: ${item.cost > 0 ? '#27ae60' : '#e74c3c'}">
                            ${item.cost > 0 ? '+' : ''}${item.cost} ü•Ñ
                        </span>
                        <button class="delete-btn" onclick="deleteActivity(${index})" title="L√∂schen">‚ùå</button>
                    </div>
                `;
                historyList.appendChild(div);
            });
        }

        function deleteActivity(index) {
            if (!confirm('Diese Aktivit√§t wirklich l√∂schen?')) return;
            
            // Get the activity to delete
            const deletedActivity = history[index];
            
            // Reverse the energy change
            currentEnergy = Math.max(0, Math.min(maxEnergy, currentEnergy - deletedActivity.cost));
            
            // Remove from history
            history.splice(index, 1);
            
            // Remove from current day's activities
            if (currentDay && currentDay.activities.length > 0) {
                // Find and remove the activity from the day's records
                const actIndex = currentDay.activities.findIndex(act => 
                    act.time === deletedActivity.time && 
                    act.activity === deletedActivity.activity
                );
                if (actIndex !== -1) {
                    currentDay.activities.splice(actIndex, 1);
                }
            }
            
            // Update displays
            updateDisplay();
            updateHistory();
            saveToLocalStorage();
        }

        function resetDay() {
            if (confirm('M√∂chtest du den Tag abschlie√üen und einen neuen starten?')) {
                // Save current day
                if (currentDay && currentDay.activities.length > 0) {
                    allDays.push(currentDay);
                    updateStatistics();
                }
                
                // Reset for new day
                currentDay = null;
                dayStarted = false;
                history = [];
                updateHistory();
                document.getElementById('morningCheckin').classList.remove('hidden');
                document.getElementById('mainDisplay').classList.add('hidden');
                document.getElementById('activitiesGrid').classList.add('hidden');
                document.getElementById('history').classList.add('hidden');
                document.getElementById('resetBtn').classList.add('hidden');
            }
            saveToLocalStorage();
        }
  
  // Update showPage function to handle motivator
function showPage(page) {
    // Update navigation
    document.querySelectorAll('.nav-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    // Show correct page
    document.querySelectorAll('.page').forEach(p => {
        p.classList.remove('active');
    });
    
    if (page === 'tracker') {
        document.getElementById('trackerPage').classList.add('active');
        if (dayStarted) {
            updateHistory();
        }
    } else if (page === 'stats') {
        document.getElementById('statsPage').classList.add('active');
        updateStatistics();
    } else if (page === 'dashboard') {
        document.getElementById('dashboardPage').classList.add('active');
        updateDashboard();
    } else if (page === 'motivator') {
        document.getElementById('motivatorPage').classList.add('active');
        loadMotivaorData();
        updateFavoritesDisplay();
        // Reset to mood selection if coming from other pages
        backToMoods();
 } else if (page === 'sensorik') {
    document.getElementById('sensorikPage').classList.add('active');
    renderSensorikGrid();
    updateSensorikResult();
    updateSensorikHistory();
 } else if (page === 'overload') {
    document.getElementById('overloadPage').classList.add('active');
    loadOverloadData();
    renderWarningGrid();
    renderEventForm();
    updateOverloadAmpel();
    updateEventHistory();
    analyzeOverloadPatterns();
 } else if (page === 'masking') {
    document.getElementById('maskingPage').classList.add('active');
    loadMaskingData();
    renderMaskingForm();
    updateMaskingHistory();
    analyzeMaskingPatterns();
 }
}


        function updateStatistics() {
            addBackupStatusToStats();
            // Total days
            document.getElementById('totalDays').textContent = allDays.length;
            
            if (allDays.length === 0) {
                document.getElementById('avgStart').textContent = '-';
                document.getElementById('avgEnd').textContent = '-';
                document.getElementById('insightsList').innerHTML = '<div class="insight-item">Noch keine Daten vorhanden. Tracke ein paar Tage, um Einblicke zu erhalten!</div>';
                document.getElementById('topDrains').innerHTML = '<p>Noch keine Daten</p>';
                document.getElementById('topGains').innerHTML = '<p>Noch keine Daten</p>';
                return;
            }
            
            // Average start and end energy
            const avgStart = allDays.reduce((sum, day) => sum + day.startEnergy, 0) / allDays.length;
            const avgEnd = allDays.reduce((sum, day) => sum + day.endEnergy, 0) / allDays.length;
            
            document.getElementById('avgStart').textContent = avgStart.toFixed(1);
            document.getElementById('avgEnd').textContent = avgEnd.toFixed(1);
            
            // Activity analysis
            const activityStats = {};
            allDays.forEach(day => {
                day.activities.forEach(act => {
                    if (!activityStats[act.activity]) {
                        activityStats[act.activity] = { count: 0, totalCost: 0, icon: act.icon };
                    }
                    activityStats[act.activity].count++;
                    activityStats[act.activity].totalCost += act.cost;
                });
            });
            
            // Top drains and gains
            const drains = Object.entries(activityStats)
                .filter(([_, stats]) => stats.totalCost < 0)
                .sort((a, b) => a[1].totalCost - b[1].totalCost)
                .slice(0, 5);
                
            const gains = Object.entries(activityStats)
                .filter(([_, stats]) => stats.totalCost > 0)
                .sort((a, b) => b[1].totalCost - a[1].totalCost)
                .slice(0, 5);
            
            document.getElementById('topDrains').innerHTML = drains
                .map(([name, stats]) => 
                    `<p><span>${stats.icon} ${name}</span><span>${stats.totalCost} ü•Ñ (${stats.count}x)</span></p>`
                ).join('');
                
            document.getElementById('topGains').innerHTML = gains
                .map(([name, stats]) => 
                    `<p><span>${stats.icon} ${name}</span><span>+${stats.totalCost} ü•Ñ (${stats.count}x)</span></p>`
                ).join('');
            
            // Generate insights
            const insights = [];
            
            // Energy difference insight
            const energyDiff = avgEnd - avgStart;
            if (energyDiff < -2) {
                insights.push('üí° Du verbrauchst im Schnitt mehr Energie als du regenerierst. Plane mehr Erholungsphasen ein!');
            } else if (energyDiff > 1) {
                insights.push('üåü Super! Du schaffst es, deine Energie gut zu managen und endest meist mit mehr L√∂ffeln als erwartet.');
            } else {
                insights.push('‚öñÔ∏è Deine Energiebilanz ist ausgeglichen. Das ist ein gutes Zeichen!');
            }
            
            // Most used activity
            const mostUsed = Object.entries(activityStats)
                .sort((a, b) => b[1].count - a[1].count)[0];
            if (mostUsed) {
                insights.push(`üîÑ "${mostUsed[0]}" machst du am h√§ufigsten (${mostUsed[1].count}x)`);
            }
            
            // Days tracked insight
            if (allDays.length >= 7) {
                insights.push('üìä Mit ' + allDays.length + ' getrackten Tagen hast du genug Daten f√ºr aussagekr√§ftige Muster!');
            }
            
            document.getElementById('insightsList').innerHTML = insights
                .map(insight => `<div class="insight-item">${insight}</div>`)
                .join('');
        }

        function exportData() {
            const exportObj = {
                version: '1.0',
                exportDate: new Date().toISOString(),
                allDays: allDays,
                currentDay: currentDay
            };
            
            const dataStr = JSON.stringify(exportObj, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `energie-tracker-${new Date().toISOString().split('T')[0]}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            localStorage.setItem('lastBackupDate', new Date().toISOString());
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importObj = JSON.parse(e.target.result);
                    
                    if (importObj.version !== '1.0') {
                        alert('Inkompatible Dateiversion');
                        return;
                    }
                    
                    if (confirm('M√∂chtest du die importierten Daten zu deinen bestehenden Daten hinzuf√ºgen?')) {
                        allDays = allDays.concat(importObj.allDays || []);
                        updateStatistics();
                        saveToLocalStorage();
                        alert('Daten erfolgreich importiert!');
                    }
                } catch (error) {
                    alert('Fehler beim Importieren der Datei');
                }
            };
            reader.readAsText(file);
        }

        // Initialize
window.onload = function() {
    // Try to load saved data
    loadFromLocalStorage();
    checkBackupReminder();
    loadMotivaorData();
    
    // If we have a saved state, restore it
    if (dayStarted) {
        document.getElementById('morningCheckin').classList.add('hidden');
        document.getElementById('mainDisplay').classList.remove('hidden');
        document.getElementById('activitiesGrid').classList.remove('hidden');
        document.getElementById('history').classList.remove('hidden');
        document.getElementById('resetBtn').classList.remove('hidden');
        document.getElementById('navigation').classList.remove('hidden');
        document.getElementById('overloadMini').classList.remove('hidden');
        
        updateDisplay();
        renderActivities();
        updateHistory();
        updateOverloadMini();
    }
    
    loadSensorikData(); // Load sensorik data
    loadOverloadData(); // Load overload data
    loadMaskingData(); // Load masking data
};

// Save to localStorage whenever data changes
function saveToLocalStorage() {
    try {
        const dataToSave = {
            currentEnergy: currentEnergy,
            maxEnergy: maxEnergy,
            dayStarted: dayStarted,
            history: history,
            currentDay: currentDay,
            allDays: allDays,
            lastSaved: new Date().toISOString()
        };
        localStorage.setItem('energieTracker', JSON.stringify(dataToSave));
        console.log('Daten automatisch gespeichert');
    } catch (e) {
        console.log('LocalStorage nicht verf√ºgbar - nutze Export-Funktion');
    }
}

// Load from localStorage
function loadFromLocalStorage() {
    try {
        const saved = localStorage.getItem('energieTracker');
        if (saved) {
            const data = JSON.parse(saved);
            currentEnergy = data.currentEnergy || 8;
            maxEnergy = data.maxEnergy || 10;
            dayStarted = data.dayStarted || false;
            history = data.history || [];
            currentDay = data.currentDay || null;
            allDays = data.allDays || [];
            
            console.log('Daten wiederhergestellt vom:', new Date(data.lastSaved).toLocaleString('de-DE'));
        }
    } catch (e) {
        console.log('Keine gespeicherten Daten gefunden oder LocalStorage nicht verf√ºgbar');
    }
}


// Backup-Reminder System f√ºr dein Neurodivergenz-Toolkit
// Einfach diesen Code in dein bestehendes JavaScript einf√ºgen

// Backup-Reminder Funktionen
function checkBackupReminder() {
    try {
        const lastBackup = localStorage.getItem('lastBackupDate');
        const now = new Date();
        
        if (!lastBackup) {
            // Noch nie ein Backup gemacht - nach 7 Tagen erinnern
            const firstUse = localStorage.getItem('firstUseDate');
            if (!firstUse) {
                localStorage.setItem('firstUseDate', now.toISOString());
                return;
            }
            
            const daysSinceFirstUse = Math.floor((now - new Date(firstUse)) / (1000 * 60 * 60 * 24));
            if (daysSinceFirstUse >= 0) {
                showBackupReminder(true); // true = erstes Backup
            }
        } else {
            // Backup vorhanden - alle 14 Tage erinnern
            const daysSinceBackup = Math.floor((now - new Date(lastBackup)) / (1000 * 60 * 60 * 24));
            if (daysSinceBackup >= 14) {
                showBackupReminder(false); // false = regul√§res Backup
            }
        }
    } catch (e) {
        console.log('Backup-Reminder nicht verf√ºgbar');
    }
}

function showBackupReminder(isFirst) {
    // Erstelle Reminder-Element wenn es noch nicht existiert
    let reminder = document.getElementById('backupReminder');
    if (!reminder) {
        reminder = document.createElement('div');
        reminder.id = 'backupReminder';
        reminder.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: #f39c12;
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            z-index: 1000;
            max-width: 300px;
            font-size: 14px;
            animation: slideIn 0.3s ease;
        `;
        
        // Animation hinzuf√ºgen
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
        `;
        document.head.appendChild(style);
        
        document.body.appendChild(reminder);
    }
    
    const message = isFirst 
        ? 'üíæ <strong>Tipp:</strong> Du nutzt den Tracker schon eine Woche! Zeit f√ºr dein erstes Backup deiner wertvollen Daten.'
        : 'üíæ <strong>Backup-Erinnerung:</strong> Dein letztes Backup ist schon 2+ Wochen her.';
    
    reminder.innerHTML = `
        ${message}
        <div style="margin-top: 10px; display: flex; gap: 10px; justify-content: flex-end;">
            <button onclick="doBackupFromReminder()" style="
                background: white; 
                color: #f39c12; 
                border: none; 
                padding: 5px 10px; 
                border-radius: 5px; 
                cursor: pointer;
                font-size: 12px;
                font-weight: bold;
            ">Backup erstellen</button>
            <button onclick="dismissBackupReminder()" style="
                background: transparent; 
                color: white; 
                border: 1px solid white; 
                padding: 5px 10px; 
                border-radius: 5px; 
                cursor: pointer;
                font-size: 12px;
            ">Sp√§ter</button>
        </div>
    `;
}

function doBackupFromReminder() {
    // Backup erstellen
    exportData();
    
    // Backup-Datum speichern
    localStorage.setItem('lastBackupDate', new Date().toISOString());
    
    // Reminder entfernen
    dismissBackupReminder();
    
    // Kurze Best√§tigung zeigen
    showBackupConfirmation();
}

function dismissBackupReminder() {
    const reminder = document.getElementById('backupReminder');
    if (reminder) {
        reminder.style.animation = 'slideOut 0.3s ease forwards';
        setTimeout(() => reminder.remove(), 300);
    }
}

function showBackupConfirmation() {
    const confirmation = document.createElement('div');
    confirmation.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: #27ae60;
        color: white;
        padding: 15px 20px;
        border-radius: 10px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        z-index: 1000;
        font-size: 14px;
        animation: slideIn 0.3s ease;
    `;
    
    confirmation.innerHTML = '‚úÖ <strong>Backup erfolgreich!</strong><br>Deine Daten sind sicher gespeichert.';
    document.body.appendChild(confirmation);
    
    // Nach 3 Sekunden wieder entfernen
    setTimeout(() => {
        confirmation.style.animation = 'slideOut 0.3s ease forwards';
        setTimeout(() => confirmation.remove(), 300);
    }, 3000);
}

function getLastBackupInfo() {
    try {
        const lastBackup = localStorage.getItem('lastBackupDate');
        if (!lastBackup) return 'Noch nie';
        
        const daysSince = Math.floor((new Date() - new Date(lastBackup)) / (1000 * 60 * 60 * 24));
        if (daysSince === 0) return 'Heute';
        if (daysSince === 1) return 'Gestern';
        return `vor ${daysSince} Tagen`;
    } catch (e) {
        return 'Unbekannt';
    }
}

// Backup-Status in der App anzeigen
function addBackupStatusToStats() {
    // Backup-Info zu den Statistiken hinzuf√ºgen
    const statsContainer = document.querySelector('.stats-grid');
    if (statsContainer) {
        const backupCard = document.createElement('div');
        backupCard.className = 'stat-card';
        backupCard.innerHTML = `
            <h3>Letztes Backup</h3>
            <div class="stat-value" style="font-size: 16px; color: #f39c12;" id="lastBackupStatus">${getLastBackupInfo()}</div>
            <button onclick="doBackupFromReminder()" style="
                margin-top: 10px;
                background: #27ae60;
                border: none;
                color: white;
                padding: 8px 16px;
                border-radius: 5px;
                cursor: pointer;
                font-size: 14px;
            ">Backup erstellen</button>
        `;
        statsContainer.appendChild(backupCard);
    }
}

// CSS f√ºr slideOut Animation hinzuf√ºgen
const slideOutStyle = document.createElement('style');
slideOutStyle.textContent = `
    @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
    }
`;
document.head.appendChild(slideOutStyle);

// INTEGRATION IN DEINE BESTEHENDE APP:

// 1. In window.onload hinzuf√ºgen:
// checkBackupReminder();

// 2. In updateStatistics() hinzuf√ºgen:
// addBackupStatusToStats();

// 3. In exportData() am Ende hinzuf√ºgen:
// localStorage.setItem('lastBackupDate', new Date().toISOString());
// Mini-Motivator Data
let currentMood = null;
let currentSuggestion = null;
let motivatorData = {
    favorites: [],
    feedback: {},
    usageStats: {}
};

const suggestions = {
    √ºberfordert: [
        { text: "Schreib 3 Dinge auf, die heute wichtig sind. W√§hl dann nur 1 davon aus.", type: "mental", icon: "üìù" },
        { text: "Stell dir einen Timer auf 5 Minuten und r√§ume nur deinen Schreibtisch auf.", type: "k√∂rperlich", icon: "‚è∞" },
        { text: "Atme 4 Sekunden ein, 6 Sekunden aus. Wiederhole das 3x.", type: "sensorisch", icon: "üå¨Ô∏è" },
        { text: "Sag dir: 'Ich darf klein anfangen.' Und tu nur 1 % davon.", type: "mental", icon: "üß©" },
        { text: "Mach kurz einen lauten Ton (z.‚ÄØB. klatschen) ‚Äì als Cut.", type: "sensorisch", icon: "üëè" },
        { text: "Such dir ein Symbol in deiner Umgebung, das f√ºr Ruhe steht.", type: "sensorisch", icon: "ü™∑" },
        { text: "Denk an jemanden, der dir raten w√ºrde: 'Mach nur das N√∂tigste.'", type: "mental", icon: "üßì" },
        { text: "Sag dir: 'Heute reicht ein Schritt. Der n√§chste kommt sp√§ter.'", type: "mental", icon: "üö∂‚Äç‚ôÄÔ∏è" },
        { text: "Nimm dir 60 Sekunden und streiche gedanklich alles, was nicht heute sein muss.", type: "mental", icon: "üóëÔ∏è" },
        { text: "Sortiere visuell 3 Gegenst√§nde auf deinem Tisch neu. Nur das.", type: "k√∂rperlich", icon: "üì¶" }
    ],
    lethargisch: [
        { text: "Steh auf und mach 5 Hampelm√§nner oder strecke dich ausgiebig.", type: "k√∂rperlich", icon: "ü§∏" },
        { text: "Spiel deinen absoluten Lieblingssong und lass dich davon mitrei√üen.", type: "sensorisch", icon: "üéµ" },
        { text: "Sag laut zu dir: 'Ich fange jetzt mit dem kleinsten Schritt an.'", type: "mental", icon: "üí¨" },
        { text: "Roll mit den Schultern vor und zur√ºck ‚Äì 3x bewusst.", type: "k√∂rperlich", icon: "üßç‚Äç‚ôÄÔ∏è" },
        { text: "Geh ans Waschbecken und bespritze dein Gesicht mit kaltem Wasser.", type: "sensorisch", icon: "üí¶" },
        { text: "Geh kurz barfu√ü (drinnen oder drau√üen).", type: "k√∂rperlich", icon: "ü¶∂" },
        { text: "L√§chele dich 5 Sekunden im Spiegel an ‚Äì auch wenn‚Äôs sich seltsam anf√ºhlt.", type: "mental", icon: "üôÇ" },
        { text: "Schreib mit einem Stift einfach deinen Namen ‚Äì 3x. Komm ins Tun.", type: "k√∂rperlich", icon: "‚úèÔ∏è" },
        { text: "Fl√ºster: 'Ich kann klein anfangen.' Wiederhole es leise 3x.", type: "mental", icon: "üîÅ" },
        { text: "Tipp 10 Sekunden rhythmisch mit den Fingern auf den Tisch.", type: "sensorisch", icon: "ü™µ" }
    ],
    verknotet: [
        { text: "Nimm einen Stift und schreibe 2 Minuten alles auf, was dir durch den Kopf geht.", type: "mental", icon: "üß†" },
        { text: "Leg dich 30 Sekunden flach hin und schau an die Decke. Einfach nur schauen.", type: "k√∂rperlich", icon: "üõèÔ∏è" },
        { text: "Fokussiere dich auf 1 Ger√§usch um dich herum. Nur das eine, 30 Sekunden lang.", type: "sensorisch", icon: "üëÇ" },
        { text: "Sag alles, was du denkst, 1 Minute laut in den Raum.", type: "mental", icon: "üó£Ô∏è" },
        { text: "R√§ume *1 Sache* auf. Nur eine. Egal was.", type: "k√∂rperlich", icon: "üß∫" },
        { text: "Stell dir vor, dein Gehirn ist ein Wollkn√§uel ‚Äì was ist der lose Faden?", type: "mental", icon: "üß∂" },
        { text: "Setz dich an einen anderen Ort im Raum ‚Äì neuer Blickwinkel.", type: "k√∂rperlich", icon: "üîÑ" },
        { text: "Sortiere willk√ºrlich: Was ist Gedanke, was Gef√ºhl, was K√∂rper?", type: "mental", icon: "üìö" },
        { text: "Zeichne Spiralen oder Kringel ‚Äì lass deine Hand das Wirrwarr zeigen.", type: "sensorisch", icon: "üåÄ" },
        { text: "Lies einen Satz laut, der dich fr√ºher beruhigt hat.", type: "mental", icon: "üìñ" }
    ],
    unruhig: [
        { text: "Geh 2 Minuten durch die Wohnung oder um den Block. Einfach gehen.", type: "k√∂rperlich", icon: "üö∂" },
        { text: "Nimm einen Gegenstand in die Hand und betaste ihn bewusst 1 Minute lang.", type: "sensorisch", icon: "‚úã" },
        { text: "Z√§hle r√ºckw√§rts von 20 zu 0 und konzentriere dich nur auf die Zahlen.", type: "mental", icon: "üî¢" },
        { text: "Zappel absichtlich mit Beinen oder H√§nden. Erlaubtes Stimming!", type: "k√∂rperlich", icon: "üåÄ" },
        { text: "Reibe deine Handfl√§chen fest aneinander und leg sie dann aufs Gesicht.", type: "sensorisch", icon: "üëê" },
        { text: "Knet etwas in deinen H√§nden ‚Äì z.‚ÄØB. Stoff, Korken oder Knetmasse.", type: "sensorisch", icon: "üßΩ" },
        { text: "Sprich in Reimen oder Unsinnss√§tzen. Sprach-Stimming erlaubt!", type: "mental", icon: "üóØÔ∏è" },
        { text: "Lauf auf der Stelle ‚Äì so schnell oder langsam, wie du willst.", type: "k√∂rperlich", icon: "üèÉ" },
        { text: "Nimm ein Kissen und dr√ºck es ganz fest an dich.", type: "sensorisch", icon: "üõèÔ∏è" },
        { text: "Mach ein Summger√§usch ‚Äì so tief und lang wie du kannst.", type: "sensorisch", icon: "üéµ" }
    ],
    blockiert: [
        { text: "√ñffne nur die App/das Dokument. Du musst nichts damit machen.", type: "mental", icon: "üì±" },
        { text: "Stell dich vor die Aufgabe und sage: 'Ich schaue mir das nur mal an.'", type: "mental", icon: "üëÄ" },
        { text: "Mach 3 tiefe Atemz√ºge und erinnere dich: Du bist nicht faul.", type: "mental", icon: "üíô" },
        { text: "Schreib: 'Ich bin blockiert, aber...'", type: "mental", icon: "‚úçÔ∏è" },
        { text: "Ber√ºhre bewusst 3 Gegenst√§nde um dich herum.", type: "sensorisch", icon: "üñêÔ∏è" },
        { text: "Schreib den Satz: 'Ich bin blockiert, aber ich bin da.'", type: "mental", icon: "‚úçÔ∏è" },
        { text: "Stell einen Wecker f√ºr 3 Minuten und mach einfach nichts.", type: "sensorisch", icon: "‚è≤Ô∏è" },
        { text: "Leg dir symbolisch den Startknopf bereit: 'Wenn ich bereit bin, dr√ºck ich innerlich drauf.'", type: "mental", icon: "üéõÔ∏è" },
        { text: "Stell dir vor: Du darfst nur beobachten, nicht handeln.", type: "mental", icon: "üîç" },
        { text: "Setz dich einmal um. Wechsel der Perspektive wirkt oft Wunder.", type: "k√∂rperlich", icon: "ü™ë" }
    ],
    √ºberreizt: [
        { text: "Dimme das Licht oder geh in einen ruhigeren Raum.", type: "sensorisch", icon: "üí°" },
        { text: "Leg dich mit einer Decke hin und schlie√üe 2 Minuten die Augen.", type: "k√∂rperlich", icon: "üõãÔ∏è" },
        { text: "Setz Kopfh√∂rer auf und spiele wei√ües Rauschen oder Naturger√§usche ab.", type: "sensorisch", icon: "üéß" },
        { text: "Zieh eine weiche Decke oder Kapuze √ºber dich.", type: "sensorisch", icon: "üß£" },
        { text: "Fl√ºstere langsam: 'Alles darf still sein.'", type: "mental", icon: "ü§´" },
        { text: "Lege etwas √ºber deine Augen ‚Äì Tuch, Kapuze, √Ñrmel.", type: "sensorisch", icon: "ü´£" },
        { text: "Sag: 'Ich bin kein Roboter. Ich darf abschalten.'", type: "mental", icon: "ü§ñ" },
        { text: "Leg dich mit den Beinen hoch, z.‚ÄØB. an die Wand. Lass die Schwerkraft arbeiten.", type: "k√∂rperlich", icon: "ü™ü" },
        { text: "K√ºhle deine Handgelenke unter kaltem Wasser ‚Äì nur 15 Sekunden.", type: "sensorisch", icon: "üßä" },
        { text: "Fl√ºstere einen beruhigenden Satz in deine H√§nde und halte sie ans Ohr.", type: "sensorisch", icon: "ü§≤" }
    ],
    prokrastinierend: [
        { text: "Stelle einen Timer auf 10 Minuten und arbeite nur so lange an der Aufgabe.", type: "mental", icon: "‚è≤Ô∏è" },
        { text: "Schreibe auf: 'Was ist das Schlimmste, was passieren kann?' Meist ist es nicht so wild.", type: "mental", icon: "‚ùì" },
        { text: "Belohne dich schon im Voraus: 'Nach 15 Minuten darf ich...'", type: "mental", icon: "üç™" },
        { text: "Starte mit dem lustigsten oder leichtesten Teil der Aufgabe.", type: "mental", icon: "üòÑ" },
        { text: "Erz√§hl dir selbst in 3 S√§tzen, warum du das eigentlich machen willst.", type: "mental", icon: "üéØ" },
        { text: "Ruf dein Zukunfts-Ich an: 'Hey, was w√ºrdest du tun?'", type: "mental", icon: "üì≤" },
        { text: "Setz dich auf den Boden ‚Äì das √§ndert den Fokus.", type: "k√∂rperlich", icon: "ü™ë" },
        { text: "Mach die Aufgabe absichtlich absurd: Erfind eine alberne Version davon.", type: "mental", icon: "üé≠" },
        { text: "Mach ein 'falsches Anfangen': Tu so, als ob du‚Äôs tust ‚Äì 10 Sekunden.", type: "k√∂rperlich", icon: "üé¨" }
    ],
    hyperfokussiert: [
        { text: "Stell dir einen Alarm f√ºr in 30 Minuten - dann machst du eine kurze Pause.", type: "mental", icon: "‚è∞" },
        { text: "Trink jetzt ein Glas Wasser und iss etwas Kleines.", type: "k√∂rperlich", icon: "üíß" },
        { text: "Notiere dir schnell, wo du gerade stehst, damit du sp√§ter weiterwei√üt.", type: "mental", icon: "üìå" },
        { text: "Steh kurz auf, streck dich, und setz dich wieder hin ‚Äì bewusst.", type: "k√∂rperlich", icon: "ü™ë" },
        { text: "Stell dir vor: Du legst eine virtuelle Lesezeichenkarte hier rein.", type: "mental", icon: "üîñ" },
        { text: "Stell dir einen kleinen digitalen 'Savepoint' vor ‚Äì wie in einem Spiel.", type: "mental", icon: "üíæ" },
        { text: "Greif einen anderen Gegenstand ‚Äì wechsel kurz die Haptik.", type: "sensorisch", icon: "üñêÔ∏è" },
        { text: "Schreib einen 5-Wort-Checkpoint wie in einem Videospiel.", type: "mental", icon: "üß©" },
        { text: "Wechsle die Sitzposition, ohne aufzustehen.", type: "k√∂rperlich", icon: "ü™ë" },
        { text: "Leg einen Gegenstand um, der sonst deine Grenze markiert (z.‚ÄØB. Stift quer vor dir).", type: "sensorisch", icon: "üìè" }
    ],
    verloren: [
        { text: "Frag dich: 'Wie f√ºhlt sich mein K√∂rper gerade an?' und horche 1 Minute in dich hinein.", type: "k√∂rperlich", icon: "ü´Ä" },
        { text: "Schreibe auf: 'Drei Dinge, die heute okay waren.' Auch ganz kleine z√§hlen.", type: "mental", icon: "‚ú®" },
        { text: "Ruf jemanden an oder schreibe jemandem - auch nur 'Hi, wie geht's?'", type: "mental", icon: "üìû" },
        { text: "Such dir 1 Farbe im Raum ‚Äì schau sie 10 Sekunden an.", type: "sensorisch", icon: "üé®" },
        { text: "Forme mit den H√§nden ein Herz oder ein Dreieck. Sp√ºr den Druck.", type: "k√∂rperlich", icon: "ü§≤" },
        { text: "Such 3 Dinge, die du magst ‚Äì Farbe, Form, Geruch.", type: "sensorisch", icon: "üß∫" },
        { text: "Lies einen Satz aus einem Buch oder Postkarte, die dir guttut.", type: "mental", icon: "üìñ" },
        { text: "Sag dir: 'Ich muss gerade nichts wissen.' Lass das Bed√ºrfnis los.", type: "mental", icon: "üéà" },
        { text: "Schau auf deine H√§nde und z√§hle die Linien auf deinen Fingern.", type: "sensorisch", icon: "‚úã" },
        { text: "Such in einem Buch einen Satz mit dem Wort 'und'.", type: "mental", icon: "üìö" }
    ],
    taub: [
        { text: "Halte etwas Warmes in den H√§nden - eine Tasse, ein Heizkissen, einen Pullover.", type: "sensorisch", icon: "‚òï" },
        { text: "Sp√ºre deine F√º√üe auf dem Boden. Bewege die Zehen bewusst.", type: "k√∂rperlich", icon: "ü¶∂" },
        { text: "Sage laut: 'Es ist okay, dass ich gerade nichts f√ºhle. Das geht vorbei.'", type: "mental", icon: "üí≠" },
        { text: "Bewege deine Zunge bewusst im Mundraum ‚Äì sp√ºr, was da ist.", type: "sensorisch", icon: "üëÖ" },
        { text: "Sag: 'Ich darf taub sein. Mein System sch√ºtzt mich gerade.'", type: "mental", icon: "üßò" },
        { text: "Dr√ºck deine H√§nde gegeneinander und sp√ºr die Spannung.", type: "k√∂rperlich", icon: "ü§≤" },
        { text: "Trommle leise mit den Fingern auf deinen Oberschenkeln ‚Äì f√ºhl den Rhythmus.", type: "sensorisch", icon: "ü•Å" },
        { text: "Reibe deine Handinnenfl√§chen sanft √ºber eine raue und eine glatte Oberfl√§che.", type: "sensorisch", icon: "üìé" },
        { text: "Mach 3 Mikrobewegungen: Augenbraue heben, Schulterzucken, Zeh bewegen.", type: "k√∂rperlich", icon: "üéØ" },
        { text: "Stell dir vor, du bist eine Schneekugel ‚Äì in Ruhe rieselt‚Äôs innen weiter.", type: "mental", icon: "üå®Ô∏è" }
    ],
    unbekannt: [
        { text: "Geh 1 Minute ans Fenster und schaue nach drau√üen.", type: "sensorisch", icon: "ü™ü" },
        { text: "Trinke bewusst einen Schluck Wasser und sp√ºre, wie es deinen K√∂rper durchl√§uft.", type: "k√∂rperlich", icon: "üíß" },
        { text: "Atme 3x tief durch und sage dir: 'Ich bin hier. Alles ist okay.'", type: "mental", icon: "üå∏" },
        { text: "Strecke deine Arme √ºber den Kopf und g√§hne absichtlich.", type: "k√∂rperlich", icon: "üôÜ" },
        { text: "Spiele 30 Sekunden lang deine Lieblingsmusik ab.", type: "sensorisch", icon: "üé∂" },
        { text: "Leg deine Hand auf deine Brust. Sp√ºr deinen Herzraum ‚Äì auch wenn nichts da ist.", type: "k√∂rperlich", icon: "ü§ç" },
        { text: "W√§hle eine zuf√§llige Aktion aus der App. Vertrauen √ºben.", type: "mental", icon: "üé≤" },
        { text: "Stell dir vor: Alles darf gerade stillstehen ‚Äì wie ein Schneekugel-Moment.", type: "mental", icon: "üå®Ô∏è" },
        { text: "Geh an einen anderen Ort ‚Äì auch wenn‚Äôs nur der Flur ist.", type: "k√∂rperlich", icon: "üö™" },
        { text: "Sp√ºre deinen Pulsschlag ‚Äì an Hals, Hand oder Brust.", type: "k√∂rperlich", icon: "‚ù§Ô∏è" },
        { text: "Such 1 Ding mit Struktur und streich es mit 2 Fingern ab.", type: "sensorisch", icon: "üßµ" },
        { text: "Schlie√üe die Augen und z√§hle 5 Ger√§usche in deiner Umgebung.", type: "sensorisch", icon: "üëÇ" }
    ]
};

// Mini-Motivator Functions
function selectMood(mood, icon) {
    currentMood = mood;
    
    // Update usage stats
    if (!motivatorData.usageStats[mood]) {
        motivatorData.usageStats[mood] = 0;
    }
    motivatorData.usageStats[mood]++;
    
    // Show suggestion
    getNewSuggestion();
    showSuggestionDisplay();
    
    // Save data
    saveMotivaorData();
}

function getNewSuggestion() {
    if (!currentMood || !suggestions[currentMood]) return;
    
    const moodSuggestions = suggestions[currentMood];
    let newSuggestion;
    
    // Try to avoid repeating the same suggestion immediately
    do {
        newSuggestion = moodSuggestions[Math.floor(Math.random() * moodSuggestions.length)];
    } while (newSuggestion === currentSuggestion && moodSuggestions.length > 1);
    
    currentSuggestion = newSuggestion;
    displaySuggestion();
}

function displaySuggestion() {
    if (!currentSuggestion) return;
    
    const content = document.getElementById('suggestionContent');
    content.innerHTML = `
        <div style="font-size: 40px; margin-bottom: 15px;">${currentSuggestion.icon}</div>
        <div>${currentSuggestion.text}</div>
        <div style="font-size: 14px; color: #95a5a6; margin-top: 15px; opacity: 0.8;">
            ${getTypeLabel(currentSuggestion.type)}
        </div>
    `;
    
    // Reset feedback buttons
    document.querySelectorAll('.feedback-btn').forEach(btn => {
        btn.classList.remove('selected');
    });
}

function getTypeLabel(type) {
    const labels = {
        'k√∂rperlich': 'üßò K√∂rperliche Aktivierung',
        'sensorisch': 'üåà Sensorische Regulation', 
        'mental': 'üß† Mentale Unterst√ºtzung'
    };
    return labels[type] || '';
}

function showSuggestionDisplay() {
    document.getElementById('moodGrid').style.display = 'none';
    document.querySelector('.motivator-subtitle').style.display = 'none';
    document.getElementById('suggestionDisplay').classList.remove('hidden');
}

function backToMoods() {
    document.getElementById('suggestionDisplay').classList.add('hidden');
    document.getElementById('moodGrid').style.display = 'grid';
    document.querySelector('.motivator-subtitle').style.display = 'block';
    currentMood = null;
    currentSuggestion = null;
}

function giveFeedback(isPositive) {
    if (!currentSuggestion || !currentMood) return;
    
    // Visual feedback
    document.querySelectorAll('.feedback-btn').forEach(btn => {
        btn.classList.remove('selected');
    });
    
    const selectedBtn = document.querySelector(`.feedback-btn.${isPositive ? 'good' : 'bad'}`);
    selectedBtn.classList.add('selected');
    
    // Store feedback
    const suggestionKey = `${currentMood}_${currentSuggestion.text.substring(0, 20)}`;
    motivatorData.feedback[suggestionKey] = {
        positive: isPositive,
        timestamp: new Date().toISOString(),
        mood: currentMood,
        suggestion: currentSuggestion
    };
    
    // Add to favorites if positive and not already there
    if (isPositive) {
        const favorite = {
            text: currentSuggestion.text,
            icon: currentSuggestion.icon,
            type: currentSuggestion.type,
            mood: currentMood
        };
        
        const alreadyFavorite = motivatorData.favorites.some(fav => 
            fav.text === favorite.text && fav.mood === favorite.mood
        );
        
        if (!alreadyFavorite) {
            motivatorData.favorites.push(favorite);
            updateFavoritesDisplay();
        }
    }
    
    saveMotivaorData();
    
    // Show brief confirmation
    setTimeout(() => {
        selectedBtn.style.transform = 'scale(1.2)';
        setTimeout(() => {
            selectedBtn.style.transform = 'scale(1.1)';
        }, 200);
    }, 100);
}

function updateFavoritesDisplay() {
    const favoritesSection = document.getElementById('favoritesSection');
    const favoritesList = document.getElementById('favoritesList');
    
    if (motivatorData.favorites.length === 0) {
        favoritesSection.classList.add('hidden');
        return;
    }
    
    favoritesSection.classList.remove('hidden');
    favoritesList.innerHTML = motivatorData.favorites.slice(-5).map(fav => 
        `<button class="favorite-item" onclick="useFavorite('${fav.text}', '${fav.icon}', '${fav.type}')" title="Von: ${fav.mood}">
            ${fav.icon} ${fav.text.substring(0, 30)}${fav.text.length > 30 ? '...' : ''}
        </button>`
    ).join('');
}

function useFavorite(text, icon, type) {
    currentSuggestion = { text, icon, type };
    displaySuggestion();
    showSuggestionDisplay();
}


// Save and load motivator data
function saveMotivaorData() {
    try {
        localStorage.setItem('motivatorData', JSON.stringify(motivatorData));
    } catch (e) {
        console.log('Could not save motivator data');
    }
}

function loadMotivaorData() {
    try {
        const saved = localStorage.getItem('motivatorData');
        if (saved) {
            motivatorData = { ...motivatorData, ...JSON.parse(saved) };
        }
    } catch (e) {
        console.log('Could not load motivator data');
    }
}

// ==========================================
// Nachtr√§gliche Erfassung (shared)
// ==========================================

function toggleRetroDatetime(module) {
    const toggle = document.getElementById(module + 'RetroToggle');
    const input = document.getElementById(module + 'RetroInput');
    const isActive = toggle.classList.toggle('active');
    
    if (isActive) {
        toggle.textContent = 'üìÖ Andere Zeit';
        input.classList.add('visible');
        // Default: gestern gleiche Uhrzeit
        const yesterday = new Date();
        yesterday.setDate(yesterday.getDate() - 1);
        input.value = yesterday.toISOString().slice(0, 16);
    } else {
        toggle.textContent = 'üïê Jetzt';
        input.classList.remove('visible');
        input.value = '';
    }
}

function resetRetroDatetime(module) {
    const toggle = document.getElementById(module + 'RetroToggle');
    const input = document.getElementById(module + 'RetroInput');
    if (toggle) {
        toggle.classList.remove('active');
        toggle.textContent = 'üïê Jetzt';
    }
    if (input) {
        input.classList.remove('visible');
        input.value = '';
    }
}

// ==========================================
// Sensorischer Umgebungs-Check
// ==========================================

let sensorikData = {
    checks: [],
    currentCheck: {}
};

const sensorikDimensions = [
    {
        id: 'licht',
        name: 'Licht',
        icon: 'üí°',
        hint: 'Reflexe, Flackern, Helligkeit, elektrisches Licht',
        levels: [
            { value: 0, emoji: '‚úÖ', label: 'Okay' },
            { value: 1, emoji: '‚ö†Ô∏è', label: 'Belastend' },
            { value: 2, emoji: 'üî¥', label: 'Zu viel' }
        ],
        suggestions: {
            1: 'Elektrisches Licht dimmen oder auf indirektes Licht wechseln. Bildschirmhelligkeit runter, Blaulichtfilter an. Tageslicht bevorzugen wenn m√∂glich.',
            2: 'Lichtquellen aus, die flackern oder reflektieren. Raum abdunkeln, Sonnenbrille oder Kappe aufsetzen. Nur eine sanfte, indirekte Lichtquelle lassen.'
        }
    },
    {
        id: 'geraeusche',
        name: 'Ger√§usche',
        icon: 'üîä',
        hint: '√úberlagerung, Ger√§uschwirrwarr, nicht filtern k√∂nnen',
        levels: [
            { value: 0, emoji: '‚úÖ', label: 'Okay' },
            { value: 1, emoji: '‚ö†Ô∏è', label: 'Unruhig' },
            { value: 2, emoji: 'üî¥', label: 'Wirrwarr' }
        ],
        suggestions: {
            1: 'Ger√§uschquellen reduzieren: eine Sache stumm schalten, T√ºr zu, oder Kopfh√∂rer mit einem einzigen Sound dr√ºber.',
            2: 'Raus aus dem Wirrwarr. Einen ruhigen Ort suchen oder Noise-Cancelling rein ‚Äì nicht um Stille zu haben, sondern um die √úberlagerung zu stoppen.'
        }
    },
    {
        id: 'gerueche',
        name: 'Ger√ºche',
        icon: 'üëÉ',
        hint: 'Intensit√§t, unangenehme Ger√ºche',
        levels: [
            { value: 0, emoji: '‚úÖ', label: 'Okay' },
            { value: 1, emoji: '‚ö†Ô∏è', label: 'Unangenehm' },
            { value: 2, emoji: 'üî¥', label: 'Intensiv' }
        ],
        suggestions: {
            1: 'Fenster √∂ffnen oder Raum wechseln. Eigenen Lieblingsduft griffbereit haben hilft.',
            2: 'Raus aus der Situation. Frische Luft, Schal/Tuch vor die Nase, Mund atmen als Notl√∂sung.'
        }
    },
    {
        id: 'temperatur',
        name: 'Temperatur',
        icon: 'üå°Ô∏è',
        hint: 'Zu warm, zu kalt, stickig',
        levels: [
            { value: 0, emoji: '‚úÖ', label: 'Okay' },
            { value: 1, emoji: '‚ö†Ô∏è', label: 'Unangenehm' },
            { value: 2, emoji: 'üî¥', label: 'Extrem' }
        ],
        suggestions: {
            1: 'Schicht an- oder ausziehen. Fenster auf/zu. Warmes/kaltes Getr√§nk holen.',
            2: 'K√∂rpertemperatur aktiv regulieren: Handgelenke k√ºhlen/w√§rmen, Ort wechseln, Decke/Ventilator.'
        }
    },
    {
        id: 'koerper',
        name: 'K√∂rpergef√ºhl',
        icon: 'üëï',
        hint: 'Kleidung, Etiketten, Texturen, Enge',
        levels: [
            { value: 0, emoji: '‚úÖ', label: 'Okay' },
            { value: 1, emoji: '‚ö†Ô∏è', label: 'St√∂rend' },
            { value: 2, emoji: 'üî¥', label: 'Unertr√§glich' }
        ],
        suggestions: {
            1: 'Was genau st√∂rt? Etikett, Naht, Enge? Wenn m√∂glich: umziehen oder lockern.',
            2: 'Sofort wechseln was geht. Bequeme Notfall-Kleidung griffbereit halten (Hoodie, weiche Hose).'
        }
    },
    {
        id: 'sozial',
        name: 'Soziale Dichte',
        icon: 'üë•',
        hint: 'Menschen, N√§he, Erwartungsdruck',
        levels: [
            { value: 0, emoji: '‚úÖ', label: 'Okay' },
            { value: 1, emoji: '‚ö†Ô∏è', label: 'Viel' },
            { value: 2, emoji: 'üî¥', label: 'Zu viel' }
        ],
        suggestions: {
            1: 'Kurz Abstand nehmen: Toilette, kurzer Gang, Kopfh√∂rer als Signal. Du darfst Pausen nehmen.',
            2: 'R√ºckzug ist jetzt Selbstschutz. Raum verlassen, allein sein, Reize runterfahren. Kein schlechtes Gewissen.'
        }
    },
    {
        id: 'visuell',
        name: 'Visuelle Unruhe',
        icon: 'üì±',
        hint: 'Bewegung, Bildschirme, Chaos, Unordnung',
        levels: [
            { value: 0, emoji: '‚úÖ', label: 'Okay' },
            { value: 1, emoji: '‚ö†Ô∏è', label: 'Unruhig' },
            { value: 2, emoji: 'üî¥', label: 'Chaotisch' }
        ],
        suggestions: {
            1: 'Blickfeld aufr√§umen: Tabs schlie√üen, Schreibtisch freir√§umen, Blick auf einen ruhigen Punkt richten.',
            2: 'Augen schlie√üen oder Blick auf einen einzigen Punkt fixieren. Weniger Bildschirme. Aufr√§umen kann warten ‚Äì erstmal Ruhe.'
        }
    }
];

function renderSensorikGrid() {
    const grid = document.getElementById('sensorikGrid');
    grid.innerHTML = '';
    
    sensorikDimensions.forEach(dim => {
        const currentValue = sensorikData.currentCheck[dim.id];
        
        const card = document.createElement('div');
        card.className = 'sensorik-card';
        card.innerHTML = `
            <div class="sensorik-card-header">
                <span class="sensorik-card-icon">${dim.icon}</span>
                <div class="sensorik-card-info">
                    <div class="sensorik-card-name">${dim.name}</div>
                    <div class="sensorik-card-hint">${dim.hint}</div>
                </div>
            </div>
            <div class="sensorik-levels">
                ${dim.levels.map(level => {
                    const selectedClass = currentValue === level.value 
                        ? (level.value === 0 ? 'selected-ok' : level.value === 1 ? 'selected-belastend' : 'selected-zuviel')
                        : '';
                    return `
                        <button class="sensorik-level-btn ${selectedClass}" 
                                onclick="setSensorikLevel('${dim.id}', ${level.value})">
                            <span class="level-emoji">${level.emoji}</span>
                            <span class="level-label">${level.label}</span>
                        </button>
                    `;
                }).join('')}
            </div>
        `;
        grid.appendChild(card);
    });
}

function setSensorikLevel(dimensionId, value) {
    sensorikData.currentCheck[dimensionId] = value;
    renderSensorikGrid();
    updateSensorikResult();
}

function updateSensorikResult() {
    const checked = Object.keys(sensorikData.currentCheck);
    if (checked.length === 0) {
        document.getElementById('sensorikResult').classList.remove('visible');
        document.getElementById('sensorikActions').style.display = 'none';
        return;
    }
    
    // Calculate score based ONLY on checked dimensions
    const checkedCount = checked.length;
    const maxScore = checkedCount * 2; // max per checked dimension
    let currentScore = 0;
    let zuVielCount = 0;
    let belastendCount = 0;
    
    sensorikDimensions.forEach(dim => {
        const val = sensorikData.currentCheck[dim.id];
        if (val !== undefined) {
            currentScore += val;
            if (val === 2) zuVielCount++;
            if (val === 1) belastendCount++;
        }
    });
    
    let percentage = maxScore > 0 ? (currentScore / maxScore) * 100 : 0;
    
    // Floor levels: "zu viel" in any dimension raises minimum
    // 1x zu viel ‚Üí mindestens 40% (deutliche Belastung)
    // 2x zu viel ‚Üí mindestens 65% (√úberlastung)
    if (zuVielCount >= 2) {
        percentage = Math.max(percentage, 65);
    } else if (zuVielCount >= 1) {
        percentage = Math.max(percentage, 40);
    }
    
    // Determine level
    let emoji, label, cssClass, barColor;
    if (percentage <= 15) {
        emoji = 'üü¢'; label = 'Sensorisch ausgeglichen'; cssClass = 'score-ok'; barColor = '#27ae60';
    } else if (percentage <= 35) {
        emoji = 'üü°'; label = 'Leicht erh√∂hte Belastung'; cssClass = 'score-erhoeht'; barColor = '#f1c40f';
    } else if (percentage <= 60) {
        emoji = 'üü†'; label = 'Deutliche Belastung'; cssClass = 'score-hoch'; barColor = '#e67e22';
    } else {
        emoji = 'üî¥'; label = 'Sensorische √úberlastung!'; cssClass = 'score-kritisch'; barColor = '#e74c3c';
    }
    
    document.getElementById('sensorikScore').textContent = emoji;
    
    const scoreLabel = document.getElementById('sensorikScoreLabel');
    scoreLabel.textContent = label;
    scoreLabel.className = 'sensorik-score-label ' + cssClass;
    
    const barFill = document.getElementById('sensorikBarFill');
    barFill.style.width = percentage + '%';
    barFill.style.background = barColor;
    
    // Generate suggestions for belastend/zuviel dimensions
    const suggestionsDiv = document.getElementById('sensorikSuggestions');
    let suggestionsHTML = '';
    
    sensorikDimensions.forEach(dim => {
        const val = sensorikData.currentCheck[dim.id];
        if (val && val > 0 && dim.suggestions[val]) {
            suggestionsHTML += `
                <div class="sensorik-suggestion-item">
                    <strong>${dim.icon} ${dim.name}:</strong> ${dim.suggestions[val]}
                </div>
            `;
        }
    });
    
    if (suggestionsHTML) {
        suggestionsDiv.innerHTML = '<h4 style="color: #f39c12; margin-bottom: 10px;">üí° Was du tun kannst:</h4>' + suggestionsHTML;
    } else {
        suggestionsDiv.innerHTML = '<p style="color: #27ae60;">Alles im gr√ºnen Bereich ‚Äì gut so! üåø</p>';
    }
    
    // Show result and actions
    document.getElementById('sensorikResult').classList.add('visible');
    
    // Show save button when at least 1 dimension is checked
    if (checked.length >= 1) {
        document.getElementById('sensorikActions').style.display = 'flex';
    }
}

function saveSensorikCheck() {
    const retroInput = document.getElementById('sensorikRetroInput');
    const retroToggle = document.getElementById('sensorikRetroToggle');
    const isRetro = retroToggle.classList.contains('active') && retroInput.value;
    const timestamp = isRetro ? new Date(retroInput.value).toISOString() : new Date().toISOString();
    
    const check = {
        id: Date.now(),
        timestamp: timestamp,
        dimensions: { ...sensorikData.currentCheck },
        score: calculateSensorikScore()
    };
    
    sensorikData.checks.unshift(check);
    sensorikData.checks.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
    
    // Keep only last 50 checks
    if (sensorikData.checks.length > 50) {
        sensorikData.checks = sensorikData.checks.slice(0, 50);
    }
    
    saveSensorikDataToStorage();
    updateSensorikHistory();
    resetRetroDatetime('sensorik');
    
    // Brief confirmation
    const btn = document.querySelector('.sensorik-save-btn');
    const originalText = btn.textContent;
    btn.textContent = '‚úÖ Gespeichert!';
    btn.style.background = '#27ae60';
    setTimeout(() => {
        btn.textContent = originalText;
        btn.style.background = '';
    }, 2000);
}

function calculateSensorikScore() {
    const checked = Object.keys(sensorikData.currentCheck).filter(k => sensorikData.currentCheck[k] !== undefined);
    const maxScore = checked.length * 2;
    let currentScore = 0;
    let zuVielCount = 0;
    
    sensorikDimensions.forEach(dim => {
        const val = sensorikData.currentCheck[dim.id];
        if (val !== undefined) {
            currentScore += val;
            if (val === 2) zuVielCount++;
        }
    });
    
    let percentage = maxScore > 0 ? Math.round((currentScore / maxScore) * 100) : 0;
    
    if (zuVielCount >= 2) percentage = Math.max(percentage, 65);
    else if (zuVielCount >= 1) percentage = Math.max(percentage, 40);
    
    return percentage;
}

function resetSensorikCheck() {
    sensorikData.currentCheck = {};
    renderSensorikGrid();
    document.getElementById('sensorikResult').classList.remove('visible');
    document.getElementById('sensorikActions').style.display = 'none';
    resetRetroDatetime('sensorik');
}

function updateSensorikHistory() {
    const list = document.getElementById('sensorikHistoryList');
    
    if (sensorikData.checks.length === 0) {
        list.innerHTML = '<p style="color: #95a5a6; text-align: center; font-style: italic;">Noch keine Checks gespeichert</p>';
        document.getElementById('sensorikPatternHint').innerHTML = '';
        return;
    }
    
    // Show last 10 checks
    list.innerHTML = sensorikData.checks.slice(0, 10).map(check => {
        const date = new Date(check.timestamp);
        const timeStr = date.toLocaleDateString('de-DE', { weekday: 'short', day: '2-digit', month: '2-digit' }) 
            + ', ' + date.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
        
        let scoreColor, scoreEmoji;
        if (check.score <= 15) { scoreColor = '#27ae60'; scoreEmoji = 'üü¢'; }
        else if (check.score <= 35) { scoreColor = '#f1c40f'; scoreEmoji = 'üü°'; }
        else if (check.score <= 60) { scoreColor = '#e67e22'; scoreEmoji = 'üü†'; }
        else { scoreColor = '#e74c3c'; scoreEmoji = 'üî¥'; }
        
        const dimTags = sensorikDimensions
            .filter(dim => check.dimensions[dim.id] !== undefined && check.dimensions[dim.id] > 0)
            .map(dim => {
                const val = check.dimensions[dim.id];
                const dimClass = val === 1 ? 'dim-belastend' : 'dim-zuviel';
                return `<span class="sensorik-history-dim ${dimClass}">${dim.icon} ${dim.name}</span>`;
            }).join('');
        
        return `
            <div class="sensorik-history-item">
                <div class="sensorik-history-header">
                    <span class="sensorik-history-time">${timeStr}</span>
                    <div style="display:flex; align-items:center; gap:8px;">
                        <span class="sensorik-history-score" style="color:${scoreColor}">
                            ${scoreEmoji} ${check.score}%
                        </span>
                        <button class="sensorik-history-delete" onclick="deleteSensorikCheck(${check.id})" title="L√∂schen">‚ùå</button>
                    </div>
                </div>
                ${dimTags ? `<div class="sensorik-history-dims">${dimTags}</div>` : '<span style="color:#27ae60; font-size:13px;">Alles ok</span>'}
            </div>
        `;
    }).join('');
    
    // Pattern analysis
    analyzeSensorikPatterns();
}

function deleteSensorikCheck(id) {
    if (!confirm('Diesen Check wirklich l√∂schen?')) return;
    sensorikData.checks = sensorikData.checks.filter(c => c.id !== id);
    saveSensorikDataToStorage();
    updateSensorikHistory();
}

function analyzeSensorikPatterns() {
    const hintDiv = document.getElementById('sensorikPatternHint');
    
    if (sensorikData.checks.length < 3) {
        hintDiv.innerHTML = '';
        return;
    }
    
    // Find most frequently problematic dimensions
    const dimCounts = {};
    const recentChecks = sensorikData.checks.slice(0, 20);
    
    recentChecks.forEach(check => {
        sensorikDimensions.forEach(dim => {
            if (check.dimensions[dim.id] && check.dimensions[dim.id] > 0) {
                if (!dimCounts[dim.id]) dimCounts[dim.id] = { name: dim.name, icon: dim.icon, count: 0, severe: 0 };
                dimCounts[dim.id].count++;
                if (check.dimensions[dim.id] === 2) dimCounts[dim.id].severe++;
            }
        });
    });
    
    const sorted = Object.values(dimCounts).sort((a, b) => b.count - a.count);
    
    if (sorted.length === 0) {
        hintDiv.innerHTML = '<div class="sensorik-pattern-hint">üåø Deine sensorische Umgebung scheint meistens in Ordnung zu sein!</div>';
        return;
    }
    
    const top = sorted[0];
    const totalChecks = recentChecks.length;
    const pct = Math.round((top.count / totalChecks) * 100);
    
    let hint = `${top.icon} <strong>${top.name}</strong> ist in ${pct}% deiner Checks belastend`;
    if (top.severe > 0) {
        hint += ` (davon ${top.severe}x kritisch)`;
    }
    hint += '. Lohnt es sich, hier dauerhaft etwas zu ver√§ndern?';
    
    hintDiv.innerHTML = `<div class="sensorik-pattern-hint">${hint}</div>`;
}

// Persistence
function saveSensorikDataToStorage() {
    try {
        localStorage.setItem('sensorikData', JSON.stringify(sensorikData));
    } catch (e) {
        console.log('Could not save sensorik data');
    }
}

function loadSensorikData() {
    try {
        const saved = localStorage.getItem('sensorikData');
        if (saved) {
            const parsed = JSON.parse(saved);
            sensorikData.checks = parsed.checks || [];
            // Don't restore currentCheck ‚Äì start fresh each time
            sensorikData.currentCheck = {};
        }
    } catch (e) {
        console.log('Could not load sensorik data');
    }
}

// ==========================================
// Overload-Tracker
// ==========================================

let overloadData = {
    activeWarnings: [],
    events: []
};

let selectedEventType = null;
let selectedTriggers = [];
let selectedEventWarnings = [];
let selectedHelped = [];
let selectedDuration = null;

const warningSignals = [
    { id: 'gedanken', name: 'Gedanken rasen', icon: 'üåÄ', desc: 'Kann nicht mehr sortieren' },
    { id: 'einsilbig', name: 'Werde einsilbig', icon: 'ü§ê', desc: 'Ziehe mich zur√ºck' },
    { id: 'reizbar', name: 'Alles nervt', icon: 'üò§', desc: 'Reizbarkeit steigt' },
    { id: 'anspannung', name: 'K√∂rperliche Anspannung', icon: 'üí™', desc: 'Unruhe, Verspannung' },
    { id: 'flucht', name: 'Will nur noch weg', icon: 'üö™', desc: 'Fluchtimpuls' },
    { id: 'leer', name: 'Kopf leer', icon: 'ü´•', desc: 'Kann nicht mehr denken' },
    { id: 'traenen', name: 'Den Tr√§nen nahe', icon: 'üò¢', desc: 'Emotionaler Druck' }
];

const eventTriggers = [
    'Sensorische √úberlastung', 'Soziale Situation', 'Unerwartete √Ñnderung',
    'Zu viele Aufgaben', 'Konfliktsituation', 'Masking zu lange',
    'Schlafmangel', 'Zeitdruck', 'Kritik/Ablehnung', 'Reiz√ºberflutung B√ºro',
    'Kein R√ºckzug m√∂glich', 'Mehrere Kleinigkeiten'
];

const helpedOptions = [
    'Allein sein', 'Stille', 'Dunkelheit', 'Gewichtsdecke', 'Weinen',
    'Stimming', 'Musik', 'Partner*in', 'Frische Luft', 'Schlaf',
    'Kaltes Wasser', 'Nichts tun', 'Lieblingsessen', 'Bewegung'
];

const durationOptions = [
    '< 30 Min', '30-60 Min', '1-2 Stunden', '2-4 Stunden',
    'Halber Tag', 'Ganzer Tag', 'Mehrere Tage'
];

const countermeasuresByLevel = {
    medium: [
        'üßò Kurze Pause einlegen ‚Äì auch 2 Minuten z√§hlen',
        'üéß Kopfh√∂rer rein, eine Ger√§uschquelle weniger',
        'üö∂ Kurz den Raum wechseln, Perspektive √§ndern',
        'üíß Etwas trinken, kurz den K√∂rper sp√ºren'
    ],
    high: [
        'üö™ R√ºckzug ist jetzt Selbstschutz, nicht Schw√§che',
        'üîá Alle nicht-essentiellen Reize sofort reduzieren',
        'üì± Nachrichten k√∂nnen warten ‚Äì du nicht',
        'ü§ù Wenn m√∂glich: jemandem sagen, dass du Pause brauchst',
        '‚è∞ Timer auf 15 Min ‚Äì dann neu bewerten'
    ],
    critical: [
        'üÜò STOPP ‚Äì Alles andere ist jetzt unwichtig',
        'üè† Sicheren Ort aufsuchen ‚Äì jetzt',
        'üß£ Reize minimieren: Licht aus, T√ºr zu, Decke dr√ºber',
        'ü´Ç Du bist nicht kaputt. Dein System sch√ºtzt sich.',
        '‚è≥ Nimm dir so viel Zeit wie du brauchst. Es gibt keine Deadline f√ºr Erholung.'
    ]
};

function renderWarningGrid() {
    const grid = document.getElementById('warningGrid');
    grid.innerHTML = '';
    
    warningSignals.forEach(signal => {
        const isActive = overloadData.activeWarnings.includes(signal.id);
        const btn = document.createElement('button');
        btn.className = 'warning-btn' + (isActive ? ' active' : '');
        btn.innerHTML = `
            <span class="warning-btn-icon">${signal.icon}</span>
            <div>
                <div style="font-weight:bold;">${signal.name}</div>
                <div style="font-size:12px; opacity:0.7;">${signal.desc}</div>
            </div>
        `;
        btn.onclick = () => toggleWarning(signal.id);
        grid.appendChild(btn);
    });
}

function toggleWarning(id) {
    const idx = overloadData.activeWarnings.indexOf(id);
    if (idx >= 0) {
        overloadData.activeWarnings.splice(idx, 1);
    } else {
        overloadData.activeWarnings.push(id);
    }
    renderWarningGrid();
    updateOverloadAmpel();
    updateOverloadMini();
    saveOverloadData();
}

function calculateOverloadRisk() {
    let risk = 0;
    
    // Factor 1: Active warnings (0-7 signals, each worth up to 12 points)
    risk += overloadData.activeWarnings.length * 12;
    
    // Factor 2: Energy level (low energy = higher risk)
    if (dayStarted && maxEnergy > 0) {
        const energyRatio = currentEnergy / maxEnergy;
        if (energyRatio <= 0.2) risk += 25;
        else if (energyRatio <= 0.4) risk += 15;
        else if (energyRatio <= 0.6) risk += 5;
    }
    
    // Factor 3: Last sensorik check
    if (sensorikData.checks.length > 0) {
        const lastCheck = sensorikData.checks[0];
        const checkAge = (Date.now() - new Date(lastCheck.timestamp).getTime()) / (1000 * 60 * 60);
        // Only count if check is less than 4 hours old
        if (checkAge < 4) {
            if (lastCheck.score > 60) risk += 20;
            else if (lastCheck.score > 35) risk += 10;
            else if (lastCheck.score > 15) risk += 5;
        }
    }
    
    return Math.min(100, risk);
}

function getRiskLevel(risk) {
    if (risk < 20) return { level: 'low', label: 'Stabil', color: '#27ae60', emoji: 'üü¢' };
    if (risk < 45) return { level: 'medium', label: 'Aufpassen', color: '#f1c40f', emoji: 'üü°' };
    if (risk < 70) return { level: 'high', label: 'Vorwarnung', color: '#e67e22', emoji: 'üü†' };
    return { level: 'critical', label: 'Akut!', color: '#e74c3c', emoji: 'üî¥' };
}

function updateOverloadAmpel() {
    const risk = calculateOverloadRisk();
    const riskInfo = getRiskLevel(risk);
    
    // Reset all dots
    ['ampelGreen', 'ampelYellow', 'ampelOrange', 'ampelRed'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.className = 'ampel-dot';
    });
    
    // Activate correct dot
    if (riskInfo.level === 'low') document.getElementById('ampelGreen').classList.add('active-green');
    else if (riskInfo.level === 'medium') document.getElementById('ampelYellow').classList.add('active-yellow');
    else if (riskInfo.level === 'high') document.getElementById('ampelOrange').classList.add('active-orange');
    else document.getElementById('ampelRed').classList.add('active-red');
    
    // Update label
    const label = document.getElementById('ampelLabel');
    label.textContent = riskInfo.emoji + ' ' + riskInfo.label;
    label.className = 'ampel-label level-' + riskInfo.level;
    
    // Detail text
    const detail = document.getElementById('ampelDetail');
    const parts = [];
    if (overloadData.activeWarnings.length > 0) {
        parts.push(overloadData.activeWarnings.length + ' Warnsignal' + (overloadData.activeWarnings.length > 1 ? 'e' : '') + ' aktiv');
    }
    if (dayStarted && currentEnergy <= Math.floor(maxEnergy * 0.3)) {
        parts.push('Energie niedrig');
    }
    if (sensorikData.checks.length > 0) {
        const lastCheck = sensorikData.checks[0];
        const checkAge = (Date.now() - new Date(lastCheck.timestamp).getTime()) / (1000 * 60 * 60);
        if (checkAge < 4 && lastCheck.score > 35) {
            parts.push('Sensorik belastet');
        }
    }
    detail.textContent = parts.length > 0 ? parts.join(' ¬∑ ') : 'Keine akuten Warnsignale';
    
    // Show countermeasures
    updateCountermeasures(riskInfo.level);
}

function updateOverloadMini() {
    const risk = calculateOverloadRisk();
    const riskInfo = getRiskLevel(risk);
    
    const dot = document.getElementById('overloadMiniDot');
    const label = document.getElementById('overloadMiniLabel');
    
    if (!dot || !label) return;
    
    dot.className = 'overload-mini-dot';
    dot.classList.add('risk-' + riskInfo.level);
    label.innerHTML = '<strong>Overload-Risiko:</strong> ' + riskInfo.label;
}

function updateCountermeasures(level) {
    const container = document.getElementById('countermeasures');
    const list = document.getElementById('countermeasuresList');
    const title = document.getElementById('countermeasuresTitle');
    
    if (level === 'low') {
        container.classList.remove('visible');
        container.classList.remove('emergency-mode');
        return;
    }
    
    container.classList.add('visible');
    
    if (level === 'critical') {
        container.classList.add('emergency-mode');
        title.textContent = 'üÜò Notfall-Modus';
    } else {
        container.classList.remove('emergency-mode');
        title.textContent = 'üí° Was du jetzt tun kannst';
    }
    
    const measures = countermeasuresByLevel[level] || countermeasuresByLevel.medium;
    list.innerHTML = measures.map(m => `<div class="countermeasure-item">${m}</div>`).join('');
}

// Event Documentation
function renderEventForm() {
    // Triggers
    const triggerGrid = document.getElementById('eventTriggerGrid');
    triggerGrid.innerHTML = eventTriggers.map(t => 
        `<button class="event-trigger-chip${selectedTriggers.includes(t) ? ' selected' : ''}" onclick="toggleEventChip('trigger', '${t}')">${t}</button>`
    ).join('');
    
    // Retrospective warnings
    const warningGrid = document.getElementById('eventWarningGrid');
    warningGrid.innerHTML = warningSignals.map(w => 
        `<button class="event-trigger-chip${selectedEventWarnings.includes(w.id) ? ' selected' : ''}" onclick="toggleEventChip('warning', '${w.id}')">${w.icon} ${w.name}</button>`
    ).join('');
    
    // What helped
    const helpedGrid = document.getElementById('eventHelpedGrid');
    helpedGrid.innerHTML = helpedOptions.map(h => 
        `<button class="event-trigger-chip${selectedHelped.includes(h) ? ' selected' : ''}" onclick="toggleEventChip('helped', '${h}')">${h}</button>`
    ).join('');
    
    // Duration
    const durationSelect = document.getElementById('eventDurationSelect');
    durationSelect.innerHTML = durationOptions.map(d => 
        `<button class="event-duration-chip${selectedDuration === d ? ' selected' : ''}" onclick="selectEventDuration('${d}')">${d}</button>`
    ).join('');
}

function selectEventType(type) {
    selectedEventType = type;
    selectedTriggers = [];
    selectedEventWarnings = [];
    selectedHelped = [];
    selectedDuration = null;
    document.getElementById('eventFreetext').value = '';
    
    // Update button states
    document.querySelectorAll('.event-type-btn').forEach(btn => btn.classList.remove('selected'));
    event.target.closest('.event-type-btn').classList.add('selected');
    
    // Show form
    document.getElementById('eventForm').classList.add('visible');
    renderEventForm();
}

function toggleEventChip(type, value) {
    let arr;
    if (type === 'trigger') arr = selectedTriggers;
    else if (type === 'warning') arr = selectedEventWarnings;
    else arr = selectedHelped;
    
    const idx = arr.indexOf(value);
    if (idx >= 0) arr.splice(idx, 1);
    else arr.push(value);
    
    renderEventForm();
}

function selectEventDuration(d) {
    selectedDuration = selectedDuration === d ? null : d;
    renderEventForm();
}

function saveOverloadEvent() {
    if (!selectedEventType) return;
    
    const evt = {
        id: Date.now(),
        timestamp: new Date().toISOString(),
        type: selectedEventType,
        triggers: [...selectedTriggers],
        retrospectiveWarnings: [...selectedEventWarnings],
        helped: [...selectedHelped],
        duration: selectedDuration,
        notes: document.getElementById('eventFreetext').value.trim(),
        energyAtTime: dayStarted ? currentEnergy : null,
        sensorikAtTime: sensorikData.checks.length > 0 ? sensorikData.checks[0].score : null
    };
    
    overloadData.events.unshift(evt);
    
    // Keep last 100 events
    if (overloadData.events.length > 100) {
        overloadData.events = overloadData.events.slice(0, 100);
    }
    
    saveOverloadData();
    
    // Reset form
    selectedEventType = null;
    selectedTriggers = [];
    selectedEventWarnings = [];
    selectedHelped = [];
    selectedDuration = null;
    document.getElementById('eventFreetext').value = '';
    document.querySelectorAll('.event-type-btn').forEach(btn => btn.classList.remove('selected'));
    document.getElementById('eventForm').classList.remove('visible');
    
    updateEventHistory();
    analyzeOverloadPatterns();
    
    // Confirmation
    const btn = document.querySelector('.event-save-btn');
    const orig = btn.textContent;
    btn.textContent = '‚úÖ Gespeichert';
    setTimeout(() => { btn.textContent = orig; }, 2000);
}

function updateEventHistory() {
    const list = document.getElementById('eventHistoryList');
    
    if (overloadData.events.length === 0) {
        list.innerHTML = '<p style="color: #95a5a6; text-align: center; font-style: italic;">Noch keine Overloads dokumentiert</p>';
        return;
    }
    
    const typeLabels = { overload: '‚ö° Overload', meltdown: 'üåã Meltdown', shutdown: 'üßä Shutdown', freeze: 'ü´• Freeze' };
    const typeColors = { overload: '#e67e22', meltdown: '#e74c3c', shutdown: '#3498db', freeze: '#9b59b6' };
    
    list.innerHTML = overloadData.events.slice(0, 15).map(evt => {
        const date = new Date(evt.timestamp);
        const timeStr = date.toLocaleDateString('de-DE', { weekday: 'short', day: '2-digit', month: '2-digit' })
            + ', ' + date.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
        
        const tags = [
            ...evt.triggers.map(t => `<span class="event-history-tag">${t}</span>`),
        ].join('');
        
        const bodyParts = [];
        if (evt.duration) bodyParts.push('Dauer: ' + evt.duration);
        if (evt.helped.length > 0) bodyParts.push('Geholfen: ' + evt.helped.join(', '));
        if (evt.notes) bodyParts.push(evt.notes);
        
        return `
            <div class="event-history-item type-${evt.type}">
                <div class="event-history-header">
                    <span class="event-history-type" style="color:${typeColors[evt.type]}">${typeLabels[evt.type]}</span>
                    <div class="event-history-meta">
                        <span class="event-history-time">${timeStr}</span>
                        <button class="event-history-delete" onclick="deleteOverloadEvent(${evt.id})" title="L√∂schen">‚ùå</button>
                    </div>
                </div>
                ${tags ? `<div class="event-history-tags">${tags}</div>` : ''}
                ${bodyParts.length > 0 ? `<div class="event-history-body">${bodyParts.join('<br>')}</div>` : ''}
            </div>
        `;
    }).join('');
}

function deleteOverloadEvent(id) {
    if (!confirm('Diesen Eintrag wirklich l√∂schen?')) return;
    overloadData.events = overloadData.events.filter(e => e.id !== id);
    saveOverloadData();
    updateEventHistory();
    analyzeOverloadPatterns();
}

function analyzeOverloadPatterns() {
    const patternList = document.getElementById('overloadPatternList');
    
    if (overloadData.events.length < 2) {
        patternList.innerHTML = '<div class="pattern-insight">Noch zu wenig Daten f√ºr Muster. Dokumentiere Overloads, um mit der Zeit Zusammenh√§nge zu erkennen.</div>';
        return;
    }
    
    const insights = [];
    const events = overloadData.events;
    
    // Type distribution
    const typeCounts = {};
    events.forEach(e => { typeCounts[e.type] = (typeCounts[e.type] || 0) + 1; });
    const typeLabels = { overload: 'Overloads', meltdown: 'Meltdowns', shutdown: 'Shutdowns', freeze: 'Freezes' };
    const typeBreakdown = Object.entries(typeCounts)
        .sort((a, b) => b[1] - a[1])
        .map(([type, count]) => `${count}x ${typeLabels[type]}`)
        .join(', ');
    insights.push(`üìä Gesamt: ${events.length} Overloads (${typeBreakdown})`);
    
    // Most common triggers
    const triggerCounts = {};
    events.forEach(e => {
        e.triggers.forEach(t => { triggerCounts[t] = (triggerCounts[t] || 0) + 1; });
    });
    const topTriggers = Object.entries(triggerCounts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 3);
    if (topTriggers.length > 0) {
        insights.push('üéØ H√§ufigste Trigger: ' + topTriggers.map(([t, c]) => `${t} (${c}x)`).join(', '));
    }
    
    // What helps most
    const helpedCounts = {};
    events.forEach(e => {
        e.helped.forEach(h => { helpedCounts[h] = (helpedCounts[h] || 0) + 1; });
    });
    const topHelped = Object.entries(helpedCounts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 3);
    if (topHelped.length > 0) {
        insights.push('‚úÖ Was am meisten hilft: ' + topHelped.map(([h, c]) => `${h} (${c}x)`).join(', '));
    }
    
    // Day of week analysis
    const dayCounts = {};
    const dayNames = ['So', 'Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa'];
    events.forEach(e => {
        const day = new Date(e.timestamp).getDay();
        dayCounts[day] = (dayCounts[day] || 0) + 1;
    });
    const peakDay = Object.entries(dayCounts).sort((a, b) => b[1] - a[1])[0];
    if (peakDay && events.length >= 5) {
        insights.push(`üìÖ H√§ufigster Tag: ${dayNames[peakDay[0]]} (${peakDay[1]}x) ‚Äì gibt es da ein Muster?`);
    }
    
    // Missed warning signs
    const missedWarnings = {};
    events.forEach(e => {
        e.retrospectiveWarnings.forEach(w => {
            missedWarnings[w] = (missedWarnings[w] || 0) + 1;
        });
    });
    const topMissed = Object.entries(missedWarnings).sort((a, b) => b[1] - a[1])[0];
    if (topMissed) {
        const signal = warningSignals.find(s => s.id === topMissed[0]);
        if (signal) {
            insights.push(`üëÅÔ∏è H√§ufigstes √ºbersehenes Signal: "${signal.name}" (${topMissed[1]}x) ‚Äì darauf besonders achten`);
        }
    }
    
    patternList.innerHTML = insights.map(i => `<div class="pattern-insight">${i}</div>`).join('');
}

// Persistence
function saveOverloadData() {
    try {
        localStorage.setItem('overloadData', JSON.stringify(overloadData));
    } catch (e) {
        console.log('Could not save overload data');
    }
}

function loadOverloadData() {
    try {
        const saved = localStorage.getItem('overloadData');
        if (saved) {
            const parsed = JSON.parse(saved);
            overloadData.events = parsed.events || [];
            overloadData.activeWarnings = parsed.activeWarnings || [];
        }
    } catch (e) {
        console.log('Could not load overload data');
    }
}

// ==========================================
// Dashboard
// ==========================================

function updateDashboard() {
    const today = new Date().toISOString().split('T')[0];
    const now = new Date();

    // Date header
    document.getElementById('dashboardDate').textContent = now.toLocaleDateString('de-DE', {
        weekday: 'long', day: 'numeric', month: 'long', year: 'numeric'
    });

    // === Energie-Karte ===
    const energyVal = document.getElementById('dashEnergyValue');
    const energySub = document.getElementById('dashEnergySub');
    if (dayStarted) {
        energyVal.textContent = currentEnergy + '/' + maxEnergy;
        const ratio = currentEnergy / maxEnergy;
        energyVal.className = 'dashboard-card-value ' +
            (ratio > 0.6 ? 'energy-ok' : ratio > 0.4 ? 'energy-warn' : ratio > 0.2 ? 'energy-low' : 'energy-crit');
        const used = maxEnergy - currentEnergy;
        energySub.textContent = used + ' verbraucht, ' + currentEnergy + ' √ºbrig';
    } else {
        energyVal.textContent = '‚Äì';
        energyVal.className = 'dashboard-card-value';
        energySub.textContent = 'Tag noch nicht gestartet';
    }

    // === Overload-Karte ===
    const overloadVal = document.getElementById('dashOverloadValue');
    const overloadSub = document.getElementById('dashOverloadSub');
    const risk = calculateOverloadRisk();
    const riskInfo = getRiskLevel(risk);
    overloadVal.textContent = riskInfo.emoji + ' ' + riskInfo.label;
    overloadVal.style.color = riskInfo.color;
    const warnCount = overloadData.activeWarnings.length;
    overloadSub.textContent = warnCount > 0 ? warnCount + ' Warnsignal' + (warnCount > 1 ? 'e' : '') + ' aktiv' : 'Keine Warnsignale';

    // === Sensorik-Karte ===
    const sensorikVal = document.getElementById('dashSensorikValue');
    const sensorikSub = document.getElementById('dashSensorikSub');
    const todayChecks = sensorikData.checks.filter(c => c.timestamp.startsWith(today));
    if (todayChecks.length > 0) {
        const latest = todayChecks[0];
        const score = latest.score;
        if (score <= 15) { sensorikVal.textContent = 'üü¢'; sensorikSub.textContent = 'Ausgeglichen'; }
        else if (score <= 35) { sensorikVal.textContent = 'üü°'; sensorikSub.textContent = 'Leicht erh√∂ht'; }
        else if (score <= 60) { sensorikVal.textContent = 'üü†'; sensorikSub.textContent = 'Deutliche Belastung'; }
        else { sensorikVal.textContent = 'üî¥'; sensorikSub.textContent = '√úberlastung'; }
        const checkTime = new Date(latest.timestamp).toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });
        sensorikSub.textContent += ' (um ' + checkTime + ')';
    } else {
        sensorikVal.textContent = '‚Äì';
        sensorikSub.textContent = 'Kein Check heute';
    }

    // === Kompensation-Karte ===
    const maskingVal = document.getElementById('dashMaskingValue');
    const maskingSub = document.getElementById('dashMaskingSub');
    const todayMasking = maskingData.entries.filter(e => e.timestamp.startsWith(today));
    if (todayMasking.length > 0) {
        const avgLevel = todayMasking.reduce((s, e) => s + e.level, 0) / todayMasking.length;
        const levelEmojis = { 1: 'üü¢', 2: 'üü°', 3: 'üü†', 4: 'üî¥' };
        const rounded = Math.round(avgLevel);
        maskingVal.textContent = levelEmojis[rounded] || 'üü°';
        const levelWords = { 1: 'Niedrig', 2: 'Sp√ºrbar', 3: 'Hoch', 4: 'Extrem' };
        maskingSub.textContent = todayMasking.length + ' Eintrag' + (todayMasking.length > 1 ? 'e' : '') + ', √ò ' + levelWords[rounded];
    } else {
        maskingVal.textContent = '‚Äì';
        maskingSub.textContent = 'Heute keine Eintr√§ge';
    }

    // === Wochen√ºberblick ===
    updateDashboardWeek(today);

    // === Cross-Module Insights ===
    updateDashboardInsights(today, todayChecks, todayMasking);
}

function updateDashboardWeek(today) {
    const weekGrid = document.getElementById('dashWeekGrid');
    const dayNames = ['So', 'Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa'];
    const days = [];

    for (let i = 6; i >= 0; i--) {
        const d = new Date();
        d.setDate(d.getDate() - i);
        const dateStr = d.toISOString().split('T')[0];
        const dayOfWeek = d.getDay();
        const isToday = dateStr === today;

        // Tagesbelastung aus allen Quellen
        let score = 0;
        let hasData = false;

        // Energie
        const dayRecord = allDays.find(day => day.date === dateStr);
        if (dayRecord) {
            const drain = dayRecord.startEnergy - dayRecord.endEnergy;
            const drainRatio = dayRecord.startEnergy > 0 ? drain / dayRecord.startEnergy : 0;
            score += drainRatio * 30;
            hasData = true;
        }
        // Heutiger Tag (noch kein allDays-Eintrag)
        if (isToday && dayStarted) {
            const drain = maxEnergy - currentEnergy;
            const drainRatio = maxEnergy > 0 ? drain / maxEnergy : 0;
            score += drainRatio * 30;
            hasData = true;
        }

        // Masking
        const dayMasking = maskingData.entries.filter(e => e.timestamp.startsWith(dateStr));
        if (dayMasking.length > 0) {
            const avgM = dayMasking.reduce((s, e) => s + e.level, 0) / dayMasking.length;
            score += avgM * 10;
            hasData = true;
        }

        // Overload events
        const dayOverloads = overloadData.events.filter(e => e.timestamp.startsWith(dateStr));
        if (dayOverloads.length > 0) {
            score += dayOverloads.length * 20;
            hasData = true;
        }

        // Sensorik
        const dayChecks = sensorikData.checks.filter(c => c.timestamp.startsWith(dateStr));
        if (dayChecks.length > 0) {
            const maxSensorik = Math.max(...dayChecks.map(c => c.score));
            score += maxSensorik * 0.3;
            hasData = true;
        }

        let dotClass = '';
        if (hasData) {
            if (score < 20) dotClass = 'dot-green';
            else if (score < 40) dotClass = 'dot-yellow';
            else if (score < 60) dotClass = 'dot-orange';
            else dotClass = 'dot-red';
        }

        days.push({
            name: dayNames[dayOfWeek],
            date: d.getDate() + '.',
            dotClass,
            isToday,
            hasData
        });
    }

    weekGrid.innerHTML = days.map(d => `
        <div class="week-day${d.isToday ? ' today' : ''}">
            <div class="week-day-name">${d.name}</div>
            <div class="week-day-dot ${d.dotClass}"></div>
            <div class="week-day-value">${d.date}</div>
        </div>
    `).join('');
}

function updateDashboardInsights(today, todayChecks, todayMasking) {
    const insightsList = document.getElementById('dashInsightsList');
    const insights = [];

    // Heutige Situation
    if (dayStarted) {
        const ratio = currentEnergy / maxEnergy;
        const todayOverloads = overloadData.events.filter(e => e.timestamp.startsWith(today));

        // Warnung: niedrige Energie + hohe Sensorik
        if (ratio <= 0.4 && todayChecks.length > 0 && todayChecks[0].score > 35) {
            insights.push('‚ö†Ô∏è Niedrige Energie und belastete Sensorik ‚Äì guter Zeitpunkt f√ºr R√ºckzug');
        }

        // Warnung: hohe Kompensation bei wenig Energie
        if (ratio <= 0.3 && todayMasking.length > 0) {
            const avgM = todayMasking.reduce((s, e) => s + e.level, 0) / todayMasking.length;
            if (avgM >= 2.5) {
                insights.push('üîã Du kompensierst viel bei wenig Energie ‚Äì das ist teuer');
            }
        }

        // Overload heute
        if (todayOverloads.length > 0) {
            insights.push('üåã ' + todayOverloads.length + ' Overload-Event' + (todayOverloads.length > 1 ? 's' : '') + ' heute ‚Äì erlaube dir Erholung');
        }
    }

    // Gestrige Belastung ‚Üí heutiger Start
    if (dayStarted && allDays.length >= 1) {
        const yesterday = new Date();
        yesterday.setDate(yesterday.getDate() - 1);
        const yesterdayStr = yesterday.toISOString().split('T')[0];

        const yesterdayMasking = maskingData.entries.filter(e => e.timestamp.startsWith(yesterdayStr));
        const yesterdayOverloads = overloadData.events.filter(e => e.timestamp.startsWith(yesterdayStr));

        if (yesterdayMasking.length > 0) {
            const avgYesterday = yesterdayMasking.reduce((s, e) => s + e.level, 0) / yesterdayMasking.length;
            if (avgYesterday >= 3 && currentEnergy <= maxEnergy * 0.6) {
                insights.push('üìâ Gestern hohe Kompensation ‚Üí heute mit weniger Energie gestartet');
            }
        }

        if (yesterdayOverloads.length > 0 && currentEnergy <= maxEnergy * 0.5) {
            insights.push('‚ö° Gestern Overload ‚Üí Energiedefizit heute sp√ºrbar');
        }
    }

    // Muster der letzten Woche
    const weekStart = new Date();
    weekStart.setDate(weekStart.getDate() - 7);
    const weekStartStr = weekStart.toISOString().split('T')[0];

    const weekMasking = maskingData.entries.filter(e => e.timestamp >= weekStartStr);
    const weekOverloads = overloadData.events.filter(e => e.timestamp >= weekStartStr);

    if (weekMasking.length >= 3) {
        const avgWeek = weekMasking.reduce((s, e) => s + e.level, 0) / weekMasking.length;
        if (avgWeek >= 3) {
            insights.push('üìä Durchschnittliche Kompensation diese Woche: hoch (√ò ' + avgWeek.toFixed(1) + '/4) ‚Äì Pass auf dich auf');
        }
    }

    if (weekOverloads.length >= 2) {
        insights.push('üî¥ ' + weekOverloads.length + ' Overload-Events diese Woche ‚Äì dein System braucht Erholung');
    }

    // Keine Insights
    if (insights.length === 0) {
        insightsList.innerHTML = '<div class="dashboard-no-data">Nutze die Module, um hier Zusammenh√§nge zu sehen. Je mehr Daten, desto besser die Erkenntnisse.</div>';
    } else {
        insightsList.innerHTML = insights.map(i => `<div class="dashboard-insight-item">${i}</div>`).join('');
    }
}

// ==========================================
// Kompensations-/Masking-Tracker
// ==========================================

let maskingData = {
    entries: []
};

let maskingState = {
    context: null,
    contextFreetext: '',
    level: null,
    reasons: []
};

const maskingContexts = [
    { id: 'buero', name: 'B√ºrotag vor Ort', icon: 'üè¢' },
    { id: 'homeoffice', name: 'Home Office', icon: 'üè†' },
    { id: 'meeting_intern', name: 'Meeting (intern)', icon: 'üë•' },
    { id: 'meeting_extern', name: 'Meeting (extern)', icon: 'ü§ù' },
    { id: 'telefon', name: 'Telefonat / Videocall', icon: 'üìû' },
    { id: 'schriftlich', name: 'Schriftliche Komm.', icon: '‚úâÔ∏è' },
    { id: 'mittagspause', name: 'Mittagspause / K√ºche', icon: '‚òï' },
    { id: 'teamevent', name: 'Team-Event / Soziales', icon: 'üéâ' },
    { id: 'termin', name: 'Termin (Arzt/Beh√∂rde)', icon: 'üìã' },
    { id: 'andere', name: 'Andere Situation', icon: '‚úèÔ∏è' }
];

const maskingLevels = [
    { id: 1, name: 'Niedrig', emoji: 'üü¢', desc: 'Kaum Aufwand' },
    { id: 2, name: 'Sp√ºrbar', emoji: 'üü°', desc: 'Bewusst kompensiert' },
    { id: 3, name: 'Hoch', emoji: 'üü†', desc: 'Deutlich anstrengend' },
    { id: 4, name: 'Extrem', emoji: 'üî¥', desc: 'Alles gegeben' }
];

const maskingReasons = [
    { id: 'sozial_performen', name: 'Soziales Performen' },
    { id: 'regeln_entschluesseln', name: 'Soziale Regeln entschl√ºsseln' },
    { id: 'unstrukturiert', name: 'Unstrukturiert / unvorhersehbar' },
    { id: 'fremde', name: 'Fremde / wenig vertraute Personen' },
    { id: 'konflikte_macht', name: 'Konflikte / Machtverh√§ltnisse' },
    { id: 'reize_unterdruecken', name: 'Reize unterdr√ºcken' },
    { id: 'beduerfnisse_zurueck', name: 'Eigene Bed√ºrfnisse zur√ºckstellen' },
    { id: 'mehrere_menschen', name: 'Mehrere Menschen gleichzeitig' },
    { id: 'angst_konsequenzen', name: 'Angst vor Konsequenzen' },
    { id: 'zeitdruck', name: 'Zeitdruck bei Reaktionen' }
];

function renderMaskingForm() {
    // Contexts
    const grid = document.getElementById('maskingContextGrid');
    grid.innerHTML = maskingContexts.map(ctx =>
        `<button class="masking-context-btn${maskingState.context === ctx.id ? ' selected' : ''}" onclick="selectMaskingContext('${ctx.id}')">
            <span class="ctx-icon">${ctx.icon}</span>${ctx.name}
        </button>`
    ).join('');

    // Freetext for "andere"
    const ft = document.getElementById('maskingContextFreetext');
    ft.classList.toggle('visible', maskingState.context === 'andere');
    ft.value = maskingState.contextFreetext;

    // Levels
    const levelSection = document.getElementById('maskingLevelSection');
    levelSection.classList.toggle('visible', maskingState.context !== null);
    const levelGrid = document.getElementById('maskingLevelGrid');
    levelGrid.innerHTML = maskingLevels.map(lvl =>
        `<button class="masking-level-btn level-${lvl.id}${maskingState.level === lvl.id ? ' selected' : ''}" onclick="selectMaskingLevel(${lvl.id})">
            <span class="level-emoji">${lvl.emoji}</span>
            <span class="level-name">${lvl.name}</span>
        </button>`
    ).join('');

    // Reasons
    const reasonSection = document.getElementById('maskingReasonSection');
    reasonSection.classList.toggle('visible', maskingState.level !== null);
    const reasonGrid = document.getElementById('maskingReasonGrid');
    reasonGrid.innerHTML = maskingReasons.map(r => {
        const isSelected = maskingState.reasons.includes(r.id);
        const isDisabled = !isSelected && maskingState.reasons.length >= 3;
        return `<button class="masking-reason-chip${isSelected ? ' selected' : ''}${isDisabled ? ' disabled' : ''}" onclick="toggleMaskingReason('${r.id}')" ${isDisabled ? 'style="opacity:0.4;cursor:default;"' : ''}>${r.name}</button>`;
    }).join('');

    // Freetext & save & retro-datetime
    const freetext = document.getElementById('maskingFreetext');
    freetext.style.display = maskingState.level !== null ? 'block' : 'none';
    const retroSection = document.getElementById('maskingRetroSection');
    retroSection.style.display = maskingState.level !== null ? 'flex' : 'none';
    const saveBtn = document.getElementById('maskingSaveBtn');
    saveBtn.classList.toggle('visible', maskingState.context !== null && maskingState.level !== null);
}

function selectMaskingContext(id) {
    maskingState.context = maskingState.context === id ? null : id;
    if (maskingState.context === null) {
        maskingState.level = null;
        maskingState.reasons = [];
    }
    if (id !== 'andere') maskingState.contextFreetext = '';
    renderMaskingForm();
}

function selectMaskingLevel(id) {
    maskingState.level = maskingState.level === id ? null : id;
    if (maskingState.level === null) maskingState.reasons = [];
    renderMaskingForm();
}

function toggleMaskingReason(id) {
    const idx = maskingState.reasons.indexOf(id);
    if (idx >= 0) {
        maskingState.reasons.splice(idx, 1);
    } else if (maskingState.reasons.length < 3) {
        maskingState.reasons.push(id);
    }
    renderMaskingForm();
}

function saveMaskingEntry() {
    if (!maskingState.context || !maskingState.level) return;

    const contextObj = maskingContexts.find(c => c.id === maskingState.context);
    let contextLabel = contextObj ? contextObj.name : maskingState.context;
    if (maskingState.context === 'andere') {
        const ft = document.getElementById('maskingContextFreetext').value.trim();
        if (ft) contextLabel = ft;
    }

    const retroInput = document.getElementById('maskingRetroInput');
    const retroToggle = document.getElementById('maskingRetroToggle');
    const isRetro = retroToggle.classList.contains('active') && retroInput.value;
    const timestamp = isRetro ? new Date(retroInput.value).toISOString() : new Date().toISOString();

    const entry = {
        id: Date.now(),
        timestamp: timestamp,
        contextId: maskingState.context,
        contextLabel: contextLabel,
        level: maskingState.level,
        reasons: maskingState.reasons.map(rid => ({
            id: rid,
            label: maskingReasons.find(r => r.id === rid)?.name || rid
        })),
        notes: document.getElementById('maskingFreetext').value.trim(),
        energyAtTime: dayStarted ? currentEnergy : null
    };

    maskingData.entries.unshift(entry);
    maskingData.entries.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
    if (maskingData.entries.length > 100) {
        maskingData.entries = maskingData.entries.slice(0, 100);
    }

    saveMaskingData();

    // Reset
    maskingState = { context: null, contextFreetext: '', level: null, reasons: [] };
    document.getElementById('maskingFreetext').value = '';
    document.getElementById('maskingContextFreetext').value = '';
    resetRetroDatetime('masking');
    renderMaskingForm();
    updateMaskingHistory();
    analyzeMaskingPatterns();

    // Confirmation
    const btn = document.getElementById('maskingSaveBtn');
    const orig = btn.textContent;
    btn.textContent = '‚úÖ Gespeichert';
    setTimeout(() => { btn.textContent = orig; }, 2000);
}

function updateMaskingHistory() {
    const list = document.getElementById('maskingHistoryList');

    if (maskingData.entries.length === 0) {
        list.innerHTML = '<p style="color: #95a5a6; text-align: center; font-style: italic;">Noch keine Eintr√§ge</p>';
        return;
    }

    const levelLabels = { 1: 'üü¢ Niedrig', 2: 'üü° Sp√ºrbar', 3: 'üü† Hoch', 4: 'üî¥ Extrem' };

    list.innerHTML = maskingData.entries.slice(0, 20).map(entry => {
        const date = new Date(entry.timestamp);
        const timeStr = date.toLocaleDateString('de-DE', { weekday: 'short', day: '2-digit', month: '2-digit' })
            + ', ' + date.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' });

        const tags = [];
        if (entry.reasons && entry.reasons.length > 0) {
            entry.reasons.forEach(r => tags.push(`<span class="masking-history-tag">${r.label}</span>`));
        }
        // Backward compat with old single-reason entries
        if (!entry.reasons && entry.reasonLabel) {
            tags.push(`<span class="masking-history-tag">${entry.reasonLabel}</span>`);
        }

        const bodyParts = [];
        bodyParts.push('Aufwand: ' + (levelLabels[entry.level] || '?'));
        if (entry.notes) bodyParts.push(entry.notes);

        return `
            <div class="masking-history-item mlevel-${entry.level}">
                <div class="masking-history-header">
                    <span class="masking-history-context">${entry.contextLabel}</span>
                    <div class="masking-history-meta">
                        <span class="masking-history-time">${timeStr}</span>
                        <button class="masking-history-delete" onclick="deleteMaskingEntry(${entry.id})" title="L√∂schen">‚ùå</button>
                    </div>
                </div>
                ${tags.length > 0 ? `<div class="masking-history-tags">${tags.join('')}</div>` : ''}
                <div class="masking-history-body">${bodyParts.join('<br>')}</div>
            </div>
        `;
    }).join('');
}

function deleteMaskingEntry(id) {
    if (!confirm('Diesen Eintrag wirklich l√∂schen?')) return;
    maskingData.entries = maskingData.entries.filter(e => e.id !== id);
    saveMaskingData();
    updateMaskingHistory();
    analyzeMaskingPatterns();
}

function analyzeMaskingPatterns() {
    const patternList = document.getElementById('maskingPatternList');
    const entries = maskingData.entries;

    if (entries.length < 3) {
        patternList.innerHTML = '<div class="masking-pattern-insight">Noch zu wenig Daten f√ºr Muster. Ab 3 Eintr√§gen werden hier Zusammenh√§nge sichtbar.</div>';
        return;
    }

    const insights = [];

    // Total & average
    const avgLevel = (entries.reduce((sum, e) => sum + e.level, 0) / entries.length).toFixed(1);
    const levelWord = avgLevel < 1.5 ? 'niedrig' : avgLevel < 2.5 ? 'sp√ºrbar' : avgLevel < 3.5 ? 'hoch' : 'extrem';
    insights.push(`üìä ${entries.length} Eintr√§ge, durchschnittlicher Aufwand: ${avgLevel}/4 (${levelWord})`);

    // Teuerste Kontexte
    const contextStats = {};
    entries.forEach(e => {
        if (!contextStats[e.contextLabel]) contextStats[e.contextLabel] = { total: 0, count: 0 };
        contextStats[e.contextLabel].total += e.level;
        contextStats[e.contextLabel].count++;
    });
    const sortedContexts = Object.entries(contextStats)
        .map(([name, stats]) => ({ name, avg: stats.total / stats.count, count: stats.count }))
        .filter(c => c.count >= 2)
        .sort((a, b) => b.avg - a.avg);

    if (sortedContexts.length > 0) {
        const top = sortedContexts[0];
        insights.push(`üè∑Ô∏è Teuerster Kontext: "${top.name}" (√ò ${top.avg.toFixed(1)}/4, ${top.count}x)`);
    }

    if (sortedContexts.length > 1) {
        const low = sortedContexts[sortedContexts.length - 1];
        insights.push(`üåø Niedrigster Kontext: "${low.name}" (√ò ${low.avg.toFixed(1)}/4, ${low.count}x)`);
    }

    // H√§ufigste Gr√ºnde (multi-select aware)
    const reasonCounts = {};
    entries.forEach(e => {
        const reasons = e.reasons || (e.reasonLabel ? [{ label: e.reasonLabel }] : []);
        reasons.forEach(r => {
            const label = r.label || r;
            reasonCounts[label] = (reasonCounts[label] || 0) + 1;
        });
    });
    const topReasons = Object.entries(reasonCounts).sort((a, b) => b[1] - a[1]).slice(0, 3);
    if (topReasons.length > 0) {
        insights.push('üéØ H√§ufigste Gr√ºnde: ' + topReasons.map(([r, c]) => `${r} (${c}x)`).join(', '));
    }

    // Reasons that correlate with high levels
    const reasonByLevel = {};
    entries.forEach(e => {
        const reasons = e.reasons || (e.reasonLabel ? [{ label: e.reasonLabel }] : []);
        reasons.forEach(r => {
            const label = r.label || r;
            if (!reasonByLevel[label]) reasonByLevel[label] = [];
            reasonByLevel[label].push(e.level);
        });
    });
    const expensiveReasons = Object.entries(reasonByLevel)
        .map(([name, levels]) => ({ name, avg: levels.reduce((a, b) => a + b, 0) / levels.length, count: levels.length }))
        .filter(r => r.count >= 2 && r.avg >= 3)
        .sort((a, b) => b.avg - a.avg);

    if (expensiveReasons.length > 0) {
        const r = expensiveReasons[0];
        insights.push(`‚ö†Ô∏è "${r.name}" f√ºhrt zuverl√§ssig zu hohem Aufwand (√ò ${r.avg.toFixed(1)}/4)`);
    }

    // H√§ufige Kombinationen
    const comboCounts = {};
    entries.forEach(e => {
        const reasons = e.reasons || [];
        if (reasons.length >= 2) {
            const labels = reasons.map(r => r.label).sort();
            for (let i = 0; i < labels.length; i++) {
                for (let j = i + 1; j < labels.length; j++) {
                    const combo = labels[i] + ' + ' + labels[j];
                    if (!comboCounts[combo]) comboCounts[combo] = { count: 0, levels: [] };
                    comboCounts[combo].count++;
                    comboCounts[combo].levels.push(e.level);
                }
            }
        }
    });
    const topCombos = Object.entries(comboCounts)
        .filter(([_, v]) => v.count >= 2)
        .sort((a, b) => b[1].count - a[1].count);

    if (topCombos.length > 0) {
        const [combo, data] = topCombos[0];
        const comboAvg = (data.levels.reduce((a, b) => a + b, 0) / data.levels.length).toFixed(1);
        insights.push(`üîó H√§ufige Kombination: "${combo}" (${data.count}x, √ò ${comboAvg}/4)`);
    }

    // Day of week
    const dayStats = {};
    const dayNames = ['So', 'Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa'];
    entries.forEach(e => {
        const day = new Date(e.timestamp).getDay();
        if (!dayStats[day]) dayStats[day] = { total: 0, count: 0 };
        dayStats[day].total += e.level;
        dayStats[day].count++;
    });
    const peakDay = Object.entries(dayStats)
        .map(([day, s]) => ({ day: dayNames[day], avg: s.total / s.count, count: s.count }))
        .filter(d => d.count >= 2)
        .sort((a, b) => b.avg - a.avg)[0];

    if (peakDay && entries.length >= 7) {
        insights.push(`üìÖ H√∂chster Durchschnitt: ${peakDay.day} (√ò ${peakDay.avg.toFixed(1)}/4)`);
    }

    // === ENERGIE-KORRELATION ===
    const dailyMasking = {};
    entries.forEach(e => {
        const day = e.timestamp.split('T')[0];
        if (!dailyMasking[day]) dailyMasking[day] = { totalLevel: 0, count: 0 };
        dailyMasking[day].totalLevel += e.level;
        dailyMasking[day].count++;
    });

    // Folgetag-Startenergie
    if (typeof allDays !== 'undefined' && allDays.length >= 3) {
        const correlationPairs = [];

        allDays.forEach(day => {
            const dayDate = new Date(day.date);
            dayDate.setDate(dayDate.getDate() - 1);
            const prevDateStr = dayDate.toISOString().split('T')[0];

            if (dailyMasking[prevDateStr]) {
                correlationPairs.push({
                    prevMasking: dailyMasking[prevDateStr].totalLevel / dailyMasking[prevDateStr].count,
                    startEnergy: day.startEnergy
                });
            }
        });

        if (correlationPairs.length >= 3) {
            const highMaskingDays = correlationPairs.filter(p => p.prevMasking >= 2.5);
            const lowMaskingDays = correlationPairs.filter(p => p.prevMasking < 2.5);

            if (highMaskingDays.length >= 2 && lowMaskingDays.length >= 2) {
                const avgStartHigh = (highMaskingDays.reduce((s, p) => s + p.startEnergy, 0) / highMaskingDays.length).toFixed(1);
                const avgStartLow = (lowMaskingDays.reduce((s, p) => s + p.startEnergy, 0) / lowMaskingDays.length).toFixed(1);
                const diff = (avgStartLow - avgStartHigh).toFixed(1);

                if (diff > 0.5) {
                    insights.push(`üîã Nach Tagen mit hoher Kompensation startest du mit √ò ${diff} L√∂ffeln weniger (${avgStartHigh} vs. ${avgStartLow})`);
                }
            }
        }

        // Gleicher Tag: Kompensation vs. Energieverlust
        const sameDayPairs = [];
        allDays.forEach(day => {
            if (dailyMasking[day.date]) {
                sameDayPairs.push({
                    masking: dailyMasking[day.date].totalLevel / dailyMasking[day.date].count,
                    energyDrain: day.startEnergy - day.endEnergy
                });
            }
        });

        if (sameDayPairs.length >= 3) {
            const highDays = sameDayPairs.filter(p => p.masking >= 2.5);
            const lowDays = sameDayPairs.filter(p => p.masking < 2.5);

            if (highDays.length >= 2 && lowDays.length >= 2) {
                const avgDrainHigh = (highDays.reduce((s, p) => s + p.energyDrain, 0) / highDays.length).toFixed(1);
                const avgDrainLow = (lowDays.reduce((s, p) => s + p.energyDrain, 0) / lowDays.length).toFixed(1);

                if (avgDrainHigh - avgDrainLow > 0.5) {
                    insights.push(`üìâ An Tagen mit hoher Kompensation verlierst du √ò ${avgDrainHigh} L√∂ffel, an leichteren nur ${avgDrainLow}`);
                }
            }
        }
    }

    patternList.innerHTML = insights.map(i => `<div class="masking-pattern-insight">${i}</div>`).join('');
}
// Persistence
function saveMaskingData() {
    try {
        localStorage.setItem('maskingData', JSON.stringify(maskingData));
    } catch (e) {
        console.log('Could not save masking data');
    }
}

function loadMaskingData() {
    try {
        const saved = localStorage.getItem('maskingData');
        if (saved) {
            const parsed = JSON.parse(saved);
            maskingData.entries = parsed.entries || [];
        }
    } catch (e) {
        console.log('Could not load masking data');
    }
}

    </script>
</body>
</html>
